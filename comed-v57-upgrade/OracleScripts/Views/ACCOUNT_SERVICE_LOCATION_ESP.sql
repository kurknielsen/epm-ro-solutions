CREATE OR REPLACE VIEW ACCOUNT_SERVICE_LOCATION_ESP ( ACCOUNT_NAME, 
ACCOUNT_ID, ACCOUNT_MODEL_OPTION, BEGIN_DATE, END_DATE, 
SERVICE_LOCATION_NAME, ESP_BEGIN_DATE, ESP_END_DATE, ESP_NAME, 
ESP_ID ) AS SELECT A.ACCOUNT_NAME, 
	A.ACCOUNT_ID, 
	A.ACCOUNT_MODEL_OPTION, 
	C.BEGIN_DATE, 
	C.END_DATE, 
	D.SERVICE_LOCATION_NAME, 
	E.BEGIN_DATE "ESP_BEGIN_DATE", 
	E.END_DATE "ESP_END_DATE", 
	F.ESP_NAME, 
	F.ESP_ID 
FROM ACCOUNT A,
	ACCOUNT_STATUS B, 
	ACCOUNT_SERVICE_LOCATION C, 
	SERVICE_LOCATION D, 
	ACCOUNT_ESP E, 
	ENERGY_SERVICE_PROVIDER F,
	ACCOUNT_STATUS_NAME G
WHERE B.ACCOUNT_ID = A.ACCOUNT_ID 
	AND TRUNC(SYSDATE) BETWEEN B.BEGIN_DATE AND NVL(B.END_DATE, HIGH_DATE)
	AND G.STATUS_NAME = B.STATUS_NAME
	AND G.IS_ACTIVE = 1   
	AND C.ACCOUNT_ID = B.ACCOUNT_ID   
	AND D.SERVICE_LOCATION_ID = C.SERVICE_LOCATION_ID 
	AND E.ACCOUNT_ID = C.ACCOUNT_ID 
	AND F.ESP_ID = E.ESP_ID 
UNION 
SELECT A.ACCOUNT_NAME, 
	A.ACCOUNT_ID, 
	A.ACCOUNT_MODEL_OPTION, 
	C.BEGIN_DATE, 
	C.END_DATE, 
	'Aggregate Account', 
	D.BEGIN_DATE "ESP_BEGIN_DATE", 
	D.END_DATE "ESP_END_DATE", 
	E.ESP_NAME, 
	E.ESP_ID 
FROM ACCOUNT A,
	ACCOUNT_STATUS B, 
	ACCOUNT_SERVICE_LOCATION C, 
	AGGREGATE_ACCOUNT_ESP D, 
	ENERGY_SERVICE_PROVIDER E,
	ACCOUNT_STATUS_NAME F
WHERE B.ACCOUNT_ID = A.ACCOUNT_ID 
	AND TRUNC(SYSDATE) BETWEEN B.BEGIN_DATE AND NVL(B.END_DATE, HIGH_DATE)
	AND F.STATUS_NAME = B.STATUS_NAME
	AND F.IS_ACTIVE = 1
	AND C.ACCOUNT_ID = B.ACCOUNT_ID 
	AND D.ACCOUNT_ID = B.ACCOUNT_ID
	AND E.ESP_ID = D.ESP_ID;
