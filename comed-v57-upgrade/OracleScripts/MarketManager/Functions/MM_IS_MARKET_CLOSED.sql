CREATE OR REPLACE FUNCTION MM_IS_MARKET_CLOSED
	(
	p_CLOSING_TYPE IN VARCHAR2,
	p_SCHEDULE_DATE IN DATE,
	p_SC_ID IN NUMBER,
	p_COMMODITY_ID IN NUMBER := 0,
	p_TRANSACTION_TYPE IN VARCHAR2 := 'All',
	p_IS_IMPORT_EXPORT IN NUMBER := 0
	) RETURN BOOLEAN AS

-- return TRUE if the market is already closed for that date.
-- get market closing information from MARKET_CLOSINGS table.
-- if an entry does not exist in the table, then assume the
-- market never closes as far as MM is concerned.
v_MARKET_CLOSE_DATE DATE;
BEGIN

--	UT.DEBUG_TRACE('MM_IS_MARKET_CLOSED');
-- 	UT.DEBUG_TRACE('CLOSING_TYPE=' || p_CLOSING_TYPE || '.');
-- 	UT.DEBUG_TRACE('SC_ID=' || TO_CHAR(p_SC_ID) || '.');
-- 	UT.DEBUG_TRACE('COMMODITY_ID=' || TO_CHAR(p_COMMODITY_ID) || '.');
-- 	UT.DEBUG_TRACE('TRANSACTION_TYPE=' || p_TRANSACTION_TYPE || '.');
-- 	UT.DEBUG_TRACE('IS_IMPORT_EXPORT=' || TO_CHAR(p_IS_IMPORT_EXPORT) || '.');

	SELECT
		CASE TRUNCATE_TO
			WHEN 'Day' THEN 
				TRUNC(p_SCHEDULE_DATE - 1/86400)
			WHEN 'Hour' THEN
				TRUNC(p_SCHEDULE_DATE - 1/86400, 'HH') + 1/24
			ELSE
				p_SCHEDULE_DATE
			END
		+ NVL(DAYS_ADDED,0) + (NVL(HOURS_ADDED,0)/24) + (NVL(MINUTES_ADDED,0)/1440)
	INTO v_MARKET_CLOSE_DATE
	FROM MARKET_CLOSINGS A
	WHERE A.CLOSING_TYPE = p_CLOSING_TYPE
		AND A.SC_ID = p_SC_ID
		AND A.COMMODITY_ID = p_COMMODITY_ID
		AND A.TRANSACTION_TYPE = p_TRANSACTION_TYPE
		AND A.IS_IMPORT_EXPORT = p_IS_IMPORT_EXPORT;

--	UT.DEBUG_TRACE('MARKET_CLOSE_DATE=' || UT.TRACE_DATE(v_MARKET_CLOSE_DATE));
--	UT.DEBUG_TRACE('MARKET CLOSED=' || UT.TRACE_BOOLEAN(SYSDATE > v_MARKET_CLOSE_DATE));
		
	RETURN SYSDATE > v_MARKET_CLOSE_DATE;

EXCEPTION
	WHEN NO_DATA_FOUND THEN
		RETURN FALSE; --Assume market does not close if it is not in table.
	WHEN OTHERS THEN
		RAISE;
END MM_IS_MARKET_CLOSED;
/

