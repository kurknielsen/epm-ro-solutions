CREATE OR REPLACE VIEW PJM_FTRQUOTES AS
--        XMLELEMENT ( "FTRQuote", XMLATTRIBUTES(BUY_SELL AS "trade"), 
--                  XMLELEMENT ( "Path", XMLATTRIBUTES(SOURCE_NAME AS "source", SINK_NAME AS "sink")),
--                  XMLELEMENT ( "Class",PEAK_CLASS),                 
--                  XMLELEMENT ( "Period",'All'),
--                  XMLELEMENT ( "Hedge",OPT_OBL),
--                  XMLELEMENT ( "MW",BID_AMOUNT),
--                  XMLELEMENT ( "Price",BID_PRICE)
SELECT T.TRANSACTION_ID, 
        B.SCHEDULE_DATE - 1/86400 "AUCTION_DATE",     --Specify, noting SCHEDULE_DATE is 1 sec after midnite, or TRUNC(AUCTION_DATE,'MM') + 1/86400
        T.TRANSACTION_TYPE "BUY_SELL",
        P1.EXTERNAL_IDENTIFIER "SOURCE_NAME",
        P2.EXTERNAL_IDENTIFIER "SINK_NAME",
        (CASE UPPER(SUBSTR(T.AGREEMENT_TYPE,5,2))
            WHEN 'ON' THEN 'OnPeak'
            WHEN 'OF' THEN 'OffPeak'
            WHEN '24' THEN '24H'
         END) "PEAK_CLASS",
        (CASE UPPER(SUBSTR(T.AGREEMENT_TYPE,-7,7))  -- Check the ending
            WHEN ' OPTION' THEN 'Option'
            WHEN 'IGATION' THEN 'Obligation'
         END) "OPT_OBL",
         B.QUANTITY "BID_AMOUNT",
         B.PRICE "BID_PRICE"
    FROM    
        BID_OFFER_SET B, 
        BID_OFFER_STATUS S,
        INTERCHANGE_TRANSACTION T,
        SERVICE_POINT P1,
        SERVICE_POINT P2
    WHERE B.SET_NUMBER = 1
        AND B.SCHEDULE_STATE = 2  --GA.EXTERNAL_STATE  --
        AND S.TRANSACTION_ID = B.TRANSACTION_ID
        AND S.SCHEDULE_DATE = B.SCHEDULE_DATE
        AND S.REVIEW_STATUS = 'Accepted'
        AND S.SUBMIT_STATUS = 'Pending'
        AND P1.SERVICE_POINT_ID = T.SOURCE_ID
        AND P2.SERVICE_POINT_ID = T.SINK_ID
        AND T.TRANSACTION_ID  = B.TRANSACTION_ID
/

CREATE OR REPLACE VIEW PJM_GEN_SCHED_STATUS AS
SELECT
	S2.TRANSACTION_ID,
	S2.SCHEDULE_DATE,
	S2.SCHEDULE_STATE,
	S2.TRAIT_VAL COMMIT_STATUS,
	S3.TRAIT_VAL ACTIVE_SCHEDULE
FROM
	IT_TRAIT_SCHEDULE S2
	LEFT OUTER JOIN (SELECT S1.TRANSACTION_ID, S1.TRAIT_VAL, S1.SCHEDULE_DATE FROM IT_TRAIT_SCHEDULE S1 WHERE 	S1.TRAIT_GROUP_ID = MM_PJM_UTIL.GET_ACTIVE_SCHEDULE_RES_TRAIT) S3
	ON S3.TRANSACTION_ID = S2.TRANSACTION_ID AND S3.SCHEDULE_DATE = S2.SCHEDULE_DATE,
	INTERCHANGE_TRANSACTION T
WHERE
	T.TRANSACTION_TYPE = 'Generation'
	AND S2.TRAIT_GROUP_ID = MM_PJM_UTIL.GET_COMMIT_STATUS_RES_TRAIT
	AND T.TRANSACTION_ID = S2.TRANSACTION_ID
/

CREATE OR REPLACE VIEW PJM_GEN_TXNS_BY_TYPE AS
SELECT
       A."TRANSACTION_ID",A."TRANSACTION_NAME",A."TRANSACTION_ALIAS",A."TRANSACTION_DESC",A."TRANSACTION_TYPE",A."TRANSACTION_CODE",A."TRANSACTION_IDENTIFIER",A."IS_FIRM",A."IS_IMPORT_SCHEDULE",A."IS_EXPORT_SCHEDULE",A."IS_BALANCE_TRANSACTION",A."IS_BID_OFFER",A."IS_EXCLUDE_FROM_POSITION",A."IS_IMPORT_EXPORT",A."IS_DISPATCHABLE",A."TRANSACTION_INTERVAL",A."EXTERNAL_INTERVAL",A."ETAG_CODE",A."BEGIN_DATE",A."END_DATE",A."PURCHASER_ID",A."SELLER_ID",A."CONTRACT_ID",A."SC_ID",A."POR_ID",A."POD_ID",A."COMMODITY_ID",A."SERVICE_TYPE_ID",A."TX_TRANSACTION_ID",A."PATH_ID",A."LINK_TRANSACTION_ID",A."EDC_ID",A."PSE_ID",A."ESP_ID",A."POOL_ID",A."SCHEDULE_GROUP_ID",A."MARKET_PRICE_ID",A."ZOR_ID",A."ZOD_ID",A."SOURCE_ID",A."SINK_ID",A."RESOURCE_ID",A."AGREEMENT_TYPE",A."APPROVAL_TYPE",A."LOSS_OPTION",A."TRAIT_CATEGORY",A."TP_ID",A."ENTRY_DATE",
       A.TRANSACTION_IDENTIFIER PJM_Gen_Id,
       B.ATTRIBUTE_VAL PJM_GEN_TXN_TYPE
FROM
       INTERCHANGE_TRANSACTION A, TEMPORAL_ENTITY_ATTRIBUTE B
WHERE
       A.TRANSACTION_TYPE = 'Generation'
       AND B.OWNER_ENTITY_ID = A.TRANSACTION_ID
       AND B.ATTRIBUTE_ID = (SELECT ATTRIBUTE_ID FROM ENTITY_ATTRIBUTE WHERE ATTRIBUTE_NAME = 'PJM_GEN_TXN_TYPE'
       AND ENTITY_DOMAIN_ID = -200);
/
       
CREATE OR REPLACE VIEW PJM_UNIT_REVENUE_ENTITIES AS
SELECT RESOURCE_NAME,
       CONTRACT_ID,
       SUM(DA_TXN_ID) DA_TXN_ID,
       SUM(RT_TXN_ID) RT_TXN_ID,
       SUM(DA_PRICE_ID) DA_PRICE_ID,
       SUM(RT_PRICE_ID) RT_PRICE_ID
  FROM (SELECT R.RESOURCE_NAME,
               T.TRANSACTION_ID DA_TXN_ID,
               0 RT_TXN_ID,
               MP.MARKET_PRICE_ID DA_PRICE_ID,
               0 RT_PRICE_ID,
							 T.CONTRACT_ID
          FROM SUPPLY_RESOURCE         R,
               INTERCHANGE_TRANSACTION T,
							 --INTERCHANGE_CONTRACT C,
               PJM_GEN_TXNS_BY_TYPE    P,
               IT_COMMODITY            COMM,
               MARKET_PRICE            MP
         WHERE R.RESOURCE_ID = T.RESOURCE_ID
           AND T.TRANSACTION_ID = P.TRANSACTION_ID
					 --AND T.CONTRACT_ID = C.CONTRACT_ID
           AND P.PJM_GEN_TXN_TYPE = 'Unit Data'
           AND T.COMMODITY_ID = COMM.COMMODITY_ID
           AND COMM.COMMODITY_ALIAS = 'DA'
           AND T.POD_ID = MP.POD_ID
           AND MP.MARKET_TYPE = 'DayAhead'
           AND MP.MARKET_PRICE_TYPE = 'Locational Marginal Price'
        UNION ALL
        SELECT R.RESOURCE_NAME,
               0 DA_TXN_ID,
               T.TRANSACTION_ID RT_TXN_ID,
               0 DA_PRICE_ID,
               MP.MARKET_PRICE_ID RT_PRICE_ID,
							 T.CONTRACT_ID
          FROM SUPPLY_RESOURCE R, INTERCHANGE_TRANSACTION T, --INTERCHANGE_CONTRACT C, 
					IT_COMMODITY COMM, MARKET_PRICE MP
         WHERE R.RESOURCE_ID = T.RESOURCE_ID
           AND T.TRANSACTION_TYPE = 'Generation'
           AND NVL(T.CONTRACT_ID, 0) != 0
					 --AND T.CONTRACT_ID=C.CONTRACT_ID
           AND T.POD_ID > 0
           AND T.COMMODITY_ID = COMM.COMMODITY_ID
           AND COMM.COMMODITY_ALIAS = 'RT'
           AND T.POD_ID = MP.POD_ID
           AND MP.MARKET_TYPE = 'RealTime'
           AND MP.MARKET_PRICE_TYPE = 'Locational Marginal Price'
        )
 GROUP BY RESOURCE_NAME, CONTRACT_ID
/

CREATE OR REPLACE VIEW ESCHEDULE_CONTRACTS AS
SELECT T.TRANSACTION_ID,
	   T.TRANSACTION_IDENTIFIER CONTRACT_CID,
	   T.TRANSACTION_TYPE,
	   T.AGREEMENT_TYPE CONTRACT_TYPE,
	   T.SC_ID,
		 T.CONTRACT_ID,
	   U.COMMODITY_ALIAS,
	   BUYER.PSE_NAME BUYER,
	   SELLER.PSE_NAME SELLER,
	   SINK.SERVICE_POINT_NAME SINK_CURVE_NAME,
	   SRC.SERVICE_POINT_NAME SOURCE_CURVE_NAME,
	   CASE U.COMMODITY_ALIAS WHEN 'DA' THEN MP_SINK.MARKET_PRICE_ID END DA_SINK_PRICE_ID,
	   CASE U.COMMODITY_ALIAS WHEN 'DA' THEN MP_SRC.MARKET_PRICE_ID END DA_SOURCE_PRICE_ID,
	   CASE U.COMMODITY_ALIAS WHEN 'DA' THEN MP_SINK_RT.MARKET_PRICE_ID END RT_SINK_PRICE_ID,
	   CASE U.COMMODITY_ALIAS WHEN 'DA' THEN MP_SRC_RT.MARKET_PRICE_ID END RT_SOURCE_PRICE_ID
  FROM INTERCHANGE_TRANSACTION   T,
	   IT_COMMODITY              U,
	   MARKET_PRICE              MP_SINK,
	   MARKET_PRICE              MP_SRC,
	   MARKET_PRICE              MP_SINK_RT,
	   MARKET_PRICE              MP_SRC_RT,
	   SERVICE_POINT             SINK,
	   SERVICE_POINT             SRC,
	   PURCHASING_SELLING_ENTITY BUYER,
	   PURCHASING_SELLING_ENTITY SELLER
 WHERE UPPER(U.COMMODITY_ALIAS) = 'DA'
   AND T.SINK_ID = MP_SINK.POD_ID
   AND MP_SINK.MARKET_TYPE = 'DayAhead'
   AND MP_SINK.MARKET_PRICE_TYPE = 'Locational Marginal Price'
   AND T.SOURCE_ID = MP_SRC.POD_ID
   AND MP_SRC.MARKET_TYPE = 'DayAhead'
   AND MP_SRC.MARKET_PRICE_TYPE = 'Locational Marginal Price'
   AND T.SINK_ID = MP_SINK_RT.POD_ID
   AND MP_SINK_RT.MARKET_TYPE = 'RealTime'
   AND MP_SINK_RT.MARKET_PRICE_TYPE = 'Locational Marginal Price'
   AND T.SOURCE_ID = MP_SRC_RT.POD_ID
   AND MP_SRC_RT.MARKET_TYPE = 'RealTime'
   AND MP_SRC_RT.MARKET_PRICE_TYPE = 'Locational Marginal Price'
   AND T.SOURCE_ID <> 0
   AND T.SINK_ID <> 0
   AND T.SC_ID = MP_SINK.SC_ID
   AND T.SC_ID = MP_SRC.SC_ID
   AND T.COMMODITY_ID = U.COMMODITY_ID
   AND T.CONTRACT_ID IS NOT NULL
   AND T.CONTRACT_ID <> 0
   AND T.TRANSACTION_TYPE IN ('Purchase', 'Sale')
   AND UPPER(T.AGREEMENT_TYPE) NOT LIKE 'FTR%'
   AND T.SINK_ID = SINK.SERVICE_POINT_ID
   AND T.SOURCE_ID = SRC.SERVICE_POINT_ID
   AND T.PURCHASER_ID = BUYER.PSE_ID
   AND T.SELLER_ID = SELLER.PSE_ID
   AND T.TRANSACTION_INTERVAL = 'Hour'
 GROUP BY T.TRANSACTION_ID,
		  T.TRANSACTION_IDENTIFIER,
		  T.TRANSACTION_TYPE,
		  T.AGREEMENT_TYPE,
		  T.SC_ID,
			T.CONTRACT_ID,
		  U.COMMODITY_ALIAS,
		  BUYER.PSE_NAME,
		  SELLER.PSE_NAME,
		  SINK.SERVICE_POINT_NAME,
		  SRC.SERVICE_POINT_NAME,
		  MP_SINK.MARKET_PRICE_ID,
	      MP_SRC.MARKET_PRICE_ID,
		  MP_SINK_RT.MARKET_PRICE_ID,
		  MP_SRC_RT.MARKET_PRICE_ID
UNION ALL
-- this is the real-time list of eSchedule contracts
SELECT T.TRANSACTION_ID,
	   T.TRANSACTION_IDENTIFIER CONTRACT_CID,
	   T.TRANSACTION_TYPE,
	   T.AGREEMENT_TYPE CONTRACT_TYPE,
	   T.SC_ID,
		 T.CONTRACT_ID,
	   U.COMMODITY_ALIAS,
	   BUYER.PSE_NAME BUYER,
	   SELLER.PSE_NAME SELLER,
	   SINK.SERVICE_POINT_NAME SINK_CURVE_NAME,
	   SRC.SERVICE_POINT_NAME SOURCE_CURVE_NAME,
	   0 DA_SINK_PRICE_ID,
	   0 DA_SOURCE_PRICE_ID,
	   CASE U.COMMODITY_ALIAS WHEN 'RT' THEN MP_SINK.MARKET_PRICE_ID END RT_SINK_PRICE_ID,
	   CASE U.COMMODITY_ALIAS WHEN 'RT' THEN MP_SRC.MARKET_PRICE_ID END RT_SOURCE_PRICE_ID
  FROM INTERCHANGE_TRANSACTION   T,
	   IT_COMMODITY              U,
	   MARKET_PRICE              MP_SINK,
	   MARKET_PRICE              MP_SRC,
	   SERVICE_POINT             SINK,
	   SERVICE_POINT             SRC,
	   PURCHASING_SELLING_ENTITY BUYER,
	   PURCHASING_SELLING_ENTITY SELLER
 WHERE UPPER(U.COMMODITY_ALIAS) = 'RT'
   AND T.SINK_ID = MP_SINK.POD_ID
   AND MP_SINK.MARKET_TYPE = 'RealTime'
   AND MP_SINK.MARKET_PRICE_TYPE = 'Locational Marginal Price'
   AND T.SOURCE_ID = MP_SRC.POD_ID
   AND MP_SRC.MARKET_TYPE = 'RealTime'
   AND MP_SRC.MARKET_PRICE_TYPE = 'Locational Marginal Price'
   AND T.SOURCE_ID <> 0 -- THIS IS TEMPORARY IN ORDER TO FIX THE TXN 5223 WHICH DOESN'T HAVE ANY SOURCE OR SINK ASSIGNED
   AND T.SINK_ID <> 0   --
   AND T.SC_ID = MP_SINK.SC_ID
   AND T.SC_ID = MP_SRC.SC_ID
   AND T.COMMODITY_ID = U.COMMODITY_ID
   AND T.CONTRACT_ID IS NOT NULL
   AND T.CONTRACT_ID <> 0
   AND T.TRANSACTION_TYPE IN ('Purchase', 'Sale')
   AND UPPER(T.AGREEMENT_TYPE) NOT LIKE 'FTR%'
   AND T.SINK_ID = SINK.SERVICE_POINT_ID
   AND T.SOURCE_ID = SRC.SERVICE_POINT_ID
   AND T.PURCHASER_ID = BUYER.PSE_ID
   AND T.SELLER_ID = SELLER.PSE_ID
   AND T.TRANSACTION_INTERVAL = 'Hour'
   AND TRANSACTION_IDENTIFIER NOT IN
	   (SELECT TRANSACTION_IDENTIFIER || 'RT'
		  FROM INTERCHANGE_TRANSACTION T, IT_COMMODITY U
		 WHERE T.CONTRACT_ID IS NOT NULL
		   AND T.TRANSACTION_TYPE IN ('Purchase', 'Sale')
		   AND UPPER(T.AGREEMENT_TYPE) NOT LIKE 'FTR%'
		   AND UPPER(U.COMMODITY_ALIAS) = 'DA'
		   AND T.COMMODITY_ID = U.COMMODITY_ID)
 GROUP BY T.TRANSACTION_ID,
		  T.TRANSACTION_IDENTIFIER,
		  T.TRANSACTION_TYPE,
		  T.AGREEMENT_TYPE,
		  T.SC_ID,
			T.CONTRACT_ID,
		  U.COMMODITY_ALIAS,
		  BUYER.PSE_NAME,
		  SELLER.PSE_NAME,
		  SINK.SERVICE_POINT_NAME,
		  SRC.SERVICE_POINT_NAME,
		  MP_SINK.MARKET_PRICE_ID,
	      MP_SRC.MARKET_PRICE_ID
/

CREATE OR REPLACE VIEW FTR_INFO AS
SELECT SRC.SERVICE_POINT_NAME SOURCE_NAME,
			 SINK.SERVICE_POINT_NAME SINK_NAME,
			 R.RESOURCE_NAME UNIT,
			 T.TRANSACTION_ID,
			 C.CONTRACT_ID,
			 T.SC_ID,
			 PSE.PSE_NAME PARTICIPANT,
			 MP_SINK.MARKET_PRICE_ID DA_SINK_PRICE_ID,
			 MP_SRC.MARKET_PRICE_ID DA_SOURCE_PRICE_ID
	FROM INTERCHANGE_TRANSACTION   T,
			 IT_COMMODITY              COMM,
			 INTERCHANGE_CONTRACT      C,
			 PURCHASING_SELLING_ENTITY PSE,
			 SERVICE_POINT             SINK,
			 SERVICE_POINT             SRC,
			 SUPPLY_RESOURCE           R,
			 MARKET_PRICE              MP_SINK,
			 MARKET_PRICE              MP_SRC
 WHERE COMM.COMMODITY_ALIAS = 'Transmission'
	 AND COMM.COMMODITY_ID = T.COMMODITY_ID
	 AND UPPER(T.AGREEMENT_TYPE) LIKE 'FTR%'
	 AND NVL(T.CONTRACT_ID, 0) != 0
	 AND T.CONTRACT_ID = C.CONTRACT_ID
	 AND T.TRANSACTION_TYPE = 'Purchase'
	 AND T.TRANSACTION_INTERVAL = 'Hour'
	 AND C.BILLING_ENTITY_ID = PSE.PSE_ID
	 AND T.SINK_ID = SINK.SERVICE_POINT_ID
	 AND T.SOURCE_ID = SRC.SERVICE_POINT_ID
	 AND SRC.SERVICE_POINT_ID > 0
	 AND SRC.SERVICE_POINT_ID = R.SERVICE_POINT_ID(+)
	 AND T.SOURCE_ID = MP_SRC.POD_ID
	 AND MP_SRC.MARKET_TYPE = 'DayAhead'
	 AND MP_SRC.MARKET_PRICE_TYPE = MM_PJM_REVENUE_REPORTS.GET_FTR_MARKET_PRICE_TYPE(SRC.NODE_TYPE)
	 AND T.SINK_ID = MP_SINK.POD_ID
	 AND MP_SINK.MARKET_TYPE = 'DayAhead'
	 AND MP_SINK.MARKET_PRICE_TYPE = MM_PJM_REVENUE_REPORTS.GET_FTR_MARKET_PRICE_TYPE(SINK.NODE_TYPE)
ORDER BY SRC.SERVICE_POINT_NAME
/
 
CREATE OR REPLACE VIEW TXN_SPLIT_POS_AND_NEG AS 
SELECT T.*, TEA.ATTRIBUTE_VAL "TXN_REPORTING_NAME", 1 "INCLUDE_POS", 0 "INCLUDE_NEG"
	FROM INTERCHANGE_TRANSACTION T, TEMPORAL_ENTITY_ATTRIBUTE TEA, ENTITY_ATTRIBUTE EA
	WHERE EA.ENTITY_DOMAIN_ID = -200
		AND EA.ATTRIBUTE_NAME = 'RevenueReportingPosAmtName'
		AND TEA.ATTRIBUTE_ID = EA.ATTRIBUTE_ID
		AND TEA.ATTRIBUTE_VAL IS NOT NULL
		AND T.TRANSACTION_ID = TEA.OWNER_ENTITY_ID
	UNION ALL
	SELECT T.*, TEA.ATTRIBUTE_VAL "TXN_REPORTING_NAME", 0 "INCLUDE_POS", 1 "INCLUDE_NEG"
	FROM INTERCHANGE_TRANSACTION T, TEMPORAL_ENTITY_ATTRIBUTE TEA, ENTITY_ATTRIBUTE EA
	WHERE EA.ENTITY_DOMAIN_ID = -200
		AND EA.ATTRIBUTE_NAME = 'RevenueReportingNegAmtName'
		AND TEA.ATTRIBUTE_ID = EA.ATTRIBUTE_ID
		AND TEA.ATTRIBUTE_VAL IS NOT NULL
		AND T.TRANSACTION_ID = TEA.OWNER_ENTITY_ID
	UNION ALL
	SELECT T.*,
		(SELECT ATTRIBUTE_VAL
		FROM TEMPORAL_ENTITY_ATTRIBUTE X, ENTITY_ATTRIBUTE EA
		 WHERE EA.ENTITY_DOMAIN_ID = -200
			AND EA.ATTRIBUTE_NAME = 'RevenueReportingName'
			AND X.ATTRIBUTE_ID = EA.ATTRIBUTE_ID
			AND X.OWNER_ENTITY_ID = T.TRANSACTION_ID) "TXN_REPORTING_NAME", 
		1 "INCLUDE_POS", 1 "INCLUDE_NEG"
	FROM INTERCHANGE_TRANSACTION T
	WHERE NOT EXISTS
		(SELECT 1 FROM TEMPORAL_ENTITY_ATTRIBUTE X, ENTITY_ATTRIBUTE EA
		 WHERE EA.ENTITY_DOMAIN_ID = -200
			AND EA.ATTRIBUTE_NAME IN ('RevenueReportingPosAmtName', 'RevenueReportingNegAmtName')
			AND X.ATTRIBUTE_ID = EA.ATTRIBUTE_ID
			AND X.OWNER_ENTITY_ID = T.TRANSACTION_ID
			AND X.ATTRIBUTE_VAL IS NOT NULL)
/

CREATE OR REPLACE VIEW PJM_TXNS_VIRTS_AS_DA_RT AS 
SELECT TRANSACTION_ID, TRANSACTION_NAME, TRANSACTION_ALIAS, TRANSACTION_DESC, TRANSACTION_TYPE, TRANSACTION_CODE, TRANSACTION_IDENTIFIER, IS_FIRM, IS_IMPORT_SCHEDULE, IS_EXPORT_SCHEDULE, IS_BALANCE_TRANSACTION, IS_BID_OFFER, IS_EXCLUDE_FROM_POSITION, IS_IMPORT_EXPORT, IS_DISPATCHABLE, TRANSACTION_INTERVAL, EXTERNAL_INTERVAL, ETAG_CODE, BEGIN_DATE, END_DATE, PURCHASER_ID, SELLER_ID, CONTRACT_ID, SC_ID, POR_ID, POD_ID,
	T.COMMODITY_ID,
	SERVICE_TYPE_ID, TX_TRANSACTION_ID, PATH_ID, LINK_TRANSACTION_ID, EDC_ID, PSE_ID, ESP_ID, POOL_ID, SCHEDULE_GROUP_ID, MARKET_PRICE_ID, ZOR_ID, ZOD_ID, SOURCE_ID, SINK_ID, RESOURCE_ID, AGREEMENT_TYPE, APPROVAL_TYPE, LOSS_OPTION, TRAIT_CATEGORY, TP_ID, T.ENTRY_DATE,
	0 "IS_VIRTUAL"
FROM INTERCHANGE_TRANSACTION T, IT_COMMODITY IC
WHERE IC.COMMODITY_ALIAS IN ('DA','RT')
	AND IC.COMMODITY_ID = T.COMMODITY_ID
UNION ALL
SELECT TRANSACTION_ID, TRANSACTION_NAME, TRANSACTION_ALIAS, TRANSACTION_DESC, TRANSACTION_TYPE, TRANSACTION_CODE, TRANSACTION_IDENTIFIER, IS_FIRM, IS_IMPORT_SCHEDULE, IS_EXPORT_SCHEDULE, IS_BALANCE_TRANSACTION, IS_BID_OFFER, IS_EXCLUDE_FROM_POSITION, IS_IMPORT_EXPORT, IS_DISPATCHABLE, TRANSACTION_INTERVAL, EXTERNAL_INTERVAL, ETAG_CODE, BEGIN_DATE, END_DATE, PURCHASER_ID, SELLER_ID, CONTRACT_ID, SC_ID, POR_ID, POD_ID,
	(SELECT COMMODITY_ID FROM IT_COMMODITY WHERE COMMODITY_ALIAS = 'DA') "COMMODITY_ID",
	SERVICE_TYPE_ID, TX_TRANSACTION_ID, PATH_ID, LINK_TRANSACTION_ID, EDC_ID, PSE_ID, ESP_ID, POOL_ID, SCHEDULE_GROUP_ID, MARKET_PRICE_ID, ZOR_ID, ZOD_ID, SOURCE_ID, SINK_ID, RESOURCE_ID, AGREEMENT_TYPE, APPROVAL_TYPE, LOSS_OPTION, TRAIT_CATEGORY, TP_ID, T.ENTRY_DATE,
	1 "IS_VIRTUAL"
FROM INTERCHANGE_TRANSACTION T, IT_COMMODITY IC
WHERE IC.COMMODITY_ALIAS = 'VR'
	AND IC.COMMODITY_ID = T.COMMODITY_ID
UNION ALL
SELECT TRANSACTION_ID, TRANSACTION_NAME, TRANSACTION_ALIAS, TRANSACTION_DESC, TRANSACTION_TYPE, TRANSACTION_CODE, TRANSACTION_IDENTIFIER, IS_FIRM, IS_IMPORT_SCHEDULE, IS_EXPORT_SCHEDULE, IS_BALANCE_TRANSACTION, IS_BID_OFFER, IS_EXCLUDE_FROM_POSITION, IS_IMPORT_EXPORT, IS_DISPATCHABLE, TRANSACTION_INTERVAL, EXTERNAL_INTERVAL, ETAG_CODE, BEGIN_DATE, END_DATE, PURCHASER_ID, SELLER_ID, CONTRACT_ID, SC_ID, POR_ID, POD_ID,
	(SELECT COMMODITY_ID FROM IT_COMMODITY WHERE COMMODITY_ALIAS = 'RT') "COMMODITY_ID",
	SERVICE_TYPE_ID, TX_TRANSACTION_ID, PATH_ID, LINK_TRANSACTION_ID, EDC_ID, PSE_ID, ESP_ID, POOL_ID, SCHEDULE_GROUP_ID, MARKET_PRICE_ID, ZOR_ID, ZOD_ID, SOURCE_ID, SINK_ID, RESOURCE_ID, AGREEMENT_TYPE, APPROVAL_TYPE, LOSS_OPTION, TRAIT_CATEGORY, TP_ID, T.ENTRY_DATE,
	1 "IS_VIRTUAL"
FROM INTERCHANGE_TRANSACTION T, IT_COMMODITY IC
WHERE IC.COMMODITY_ALIAS = 'VR'
	AND IC.COMMODITY_ID = T.COMMODITY_ID
MINUS
--exclude 'AP MP:31636RT:AETSAP@DA OVEC' AND 'AETS:31636RT:AETSAP@DA OVEC' from Trades by Contract report    
SELECT TRANSACTION_ID, TRANSACTION_NAME, TRANSACTION_ALIAS, TRANSACTION_DESC, TRANSACTION_TYPE, TRANSACTION_CODE, TRANSACTION_IDENTIFIER, IS_FIRM, IS_IMPORT_SCHEDULE, IS_EXPORT_SCHEDULE, IS_BALANCE_TRANSACTION, IS_BID_OFFER, IS_EXCLUDE_FROM_POSITION, IS_IMPORT_EXPORT, IS_DISPATCHABLE, TRANSACTION_INTERVAL, EXTERNAL_INTERVAL, ETAG_CODE, T.BEGIN_DATE, T.END_DATE, T.PURCHASER_ID, T.SELLER_ID, T.CONTRACT_ID, T.SC_ID, T.POR_ID, T.POD_ID,
	T.COMMODITY_ID,
	SERVICE_TYPE_ID, TX_TRANSACTION_ID, PATH_ID, LINK_TRANSACTION_ID, T.EDC_ID, PSE_ID, ESP_ID, POOL_ID, SCHEDULE_GROUP_ID, MARKET_PRICE_ID, ZOR_ID, ZOD_ID, T.SOURCE_ID, T.SINK_ID, RESOURCE_ID, T.AGREEMENT_TYPE, T.APPROVAL_TYPE, T.LOSS_OPTION, TRAIT_CATEGORY, T.TP_ID, T.ENTRY_DATE,
	0 "IS_VIRTUAL"
FROM INTERCHANGE_TRANSACTION T, IT_COMMODITY IC, INTERCHANGE_CONTRACT C, SERVICE_POINT S
WHERE IC.COMMODITY_ALIAS = 'RT'
	AND IC.COMMODITY_ID = T.COMMODITY_ID
    AND T.TRANSACTION_TYPE IN ('Purchase', 'Sale')
    AND C.CONTRACT_NAME IN ('AETS', 'AP MP')
    AND T.CONTRACT_ID = C.CONTRACT_ID
    AND S.SERVICE_POINT_NAME = 'OVEC'
    AND T.POD_ID = S.SERVICE_POINT_ID
    AND T.TRANSACTION_IDENTIFIER LIKE '%RT';
/

CREATE OR REPLACE VIEW PJM_UNIT_REV_BY_SIGN AS 
--Get the DA Generation Txns
SELECT NVL(T.TXN_REPORTING_NAME, R.RESOURCE_NAME) "RESOURCE_NAME",
		T.TRANSACTION_ID,
		T.BEGIN_DATE,
		T.END_DATE,
		MP.MARKET_PRICE_ID,
		COMM.MARKET_TYPE,
		T.CONTRACT_ID, T.INCLUDE_POS, T.INCLUDE_NEG,
		0 IS_VIRTUAL,
		T.TRANSACTION_TYPE
	FROM SUPPLY_RESOURCE R,
		TXN_SPLIT_POS_AND_NEG T,
		PJM_GEN_TXNS_BY_TYPE P,
		IT_COMMODITY COMM,
		MARKET_PRICE MP
	WHERE R.RESOURCE_ID = T.RESOURCE_ID
		AND R.RESOURCE_ID > 0
		AND T.TRANSACTION_ID = P.TRANSACTION_ID
		AND P.PJM_GEN_TXN_TYPE = 'Unit Data'
		AND T.COMMODITY_ID = COMM.COMMODITY_ID
		AND COMM.COMMODITY_ALIAS = 'DA'
		AND MP.MARKET_PRICE_TYPE = 'Locational Marginal Price'
		AND MP.MARKET_TYPE = COMM.MARKET_TYPE
		AND MP.POD_ID = T.POD_ID
	UNION ALL
    --Get the RT Generation Txns
	SELECT NVL(T.TXN_REPORTING_NAME, R.RESOURCE_NAME) RESOURCE_NAME,
		T.TRANSACTION_ID,
		T.BEGIN_DATE,
		T.END_DATE,
		MP.MARKET_PRICE_ID,
		COMM.MARKET_TYPE,
		T.CONTRACT_ID, T.INCLUDE_POS, T.INCLUDE_NEG,
		0 IS_VIRTUAL,
		T.TRANSACTION_TYPE
	FROM SUPPLY_RESOURCE R,
		TXN_SPLIT_POS_AND_NEG T,
		IT_COMMODITY COMM,
		MARKET_PRICE MP
	WHERE R.RESOURCE_ID = T.RESOURCE_ID
		AND R.RESOURCE_ID > 0
		AND T.TRANSACTION_TYPE = 'Generation'
		AND T.CONTRACT_ID > 0
		AND T.COMMODITY_ID = COMM.COMMODITY_ID
		AND COMM.COMMODITY_ALIAS = 'RT'
		AND MP.MARKET_PRICE_TYPE = 'Locational Marginal Price'
		AND MP.MARKET_TYPE = COMM.MARKET_TYPE
		AND MP.POD_ID = T.POD_ID
	UNION ALL
    --Get the OVEC Virtual and the OVEC Import/Exports (AYE Specific)
	SELECT 'XIC  OVEC' "RESOURCE_NAME",
		T.TRANSACTION_ID,
		T.BEGIN_DATE,
		T.END_DATE,
		MP.MARKET_PRICE_ID,
		COMM.MARKET_TYPE,
		T.CONTRACT_ID, 1, 1,
		COMM.IS_VIRTUAL "IS_VIRTUAL",
		T.TRANSACTION_TYPE
	FROM SERVICE_POINT SP,
		INTERCHANGE_TRANSACTION T,
		IT_COMMODITY COMM,
		MARKET_PRICE MP
	WHERE SP.SERVICE_POINT_NAME = 'OVEC'
		AND ((T.TRANSACTION_TYPE = 'Purchase' AND SP.SERVICE_POINT_ID = T.POR_ID)
			OR (T.TRANSACTION_TYPE IN ('Generation','Sale') AND SP.SERVICE_POINT_ID = T.POD_ID))
		AND COMM.COMMODITY_ID = T.COMMODITY_ID
		AND ((COMM.COMMODITY_ALIAS = 'RT' AND T.IS_IMPORT_EXPORT = 1)
			OR COMM.COMMODITY_ALIAS = 'VR')
		AND MP.MARKET_PRICE_TYPE = 'Locational Marginal Price'
		AND MP.MARKET_TYPE = COMM.MARKET_TYPE
		AND MP.POD_ID = SP.SERVICE_POINT_ID
	UNION ALL
    --Get a row representing the RT side of the OVEC Virtual (AYE Specific)
	SELECT 'XIC  OVEC' "RESOURCE_NAME",
		T.TRANSACTION_ID,
		T.BEGIN_DATE,
		T.END_DATE,
		MP.MARKET_PRICE_ID,
		'RealTime',
		T.CONTRACT_ID, 1, 1,
		COMM.IS_VIRTUAL "IS_VIRTUAL",
		T.TRANSACTION_TYPE
	FROM SERVICE_POINT SP,
		INTERCHANGE_TRANSACTION T,
		IT_COMMODITY COMM,
		MARKET_PRICE MP
	WHERE SP.SERVICE_POINT_NAME = 'OVEC'
		AND T.TRANSACTION_TYPE = 'Generation'
		AND SP.SERVICE_POINT_ID = T.POD_ID
		AND COMM.COMMODITY_ID = T.COMMODITY_ID
		AND COMM.COMMODITY_ALIAS = 'VR'
		AND MP.MARKET_PRICE_TYPE = 'Locational Marginal Price'
		AND MP.MARKET_TYPE = 'RealTime'
		AND MP.POD_ID = SP.SERVICE_POINT_ID
    UNION ALL
    --Get the AETS Sales and AP MP Purchases at OVEC (AYE Specific)
    SELECT 'XIC  OVEC' "RESOURCE_NAME",
            T.TRANSACTION_ID,
            T.BEGIN_DATE,
            T.END_DATE,
            MP.MARKET_PRICE_ID,
            COMM.MARKET_TYPE,
            T.CONTRACT_ID, 1, 1,
            COMM.IS_VIRTUAL "IS_VIRTUAL",
            T.TRANSACTION_TYPE
    FROM SERVICE_POINT SP,
            INTERCHANGE_TRANSACTION T,
            IT_COMMODITY COMM,
            MARKET_PRICE MP,
        INTERCHANGE_CONTRACT IC
    WHERE SP.SERVICE_POINT_NAME = 'OVEC'
        AND IC.CONTRACT_NAME IN('AETS', 'AP MP')
        AND T.TRANSACTION_TYPE IN('Purchase', 'Sale')      
        AND SP.SERVICE_POINT_ID = T.POD_ID
        AND T.CONTRACT_ID = IC.CONTRACT_ID
        AND COMM.COMMODITY_ID = T.COMMODITY_ID
        AND COMM.COMMODITY_ALIAS IN ('DA', 'RT')
        AND MP.MARKET_PRICE_TYPE = 'Locational Marginal Price'
        AND MP.MARKET_TYPE = COMM.MARKET_TYPE
        AND MP.POD_ID = SP.SERVICE_POINT_ID

/

CREATE OR REPLACE VIEW FTR_ACCOUNTS
(PARTICIPANT, TRANSACTION_ID, SC_ID, DA_SINK_PRICE_ID, DA_SOURCE_PRICE_ID)
AS 
SELECT PSE.PSE_NAME PARTICIPANT,
				   T.TRANSACTION_ID,
				   T.SC_ID,
				   MP_SINK.MARKET_PRICE_ID DA_SINK_PRICE_ID,
				   MP_SRC.MARKET_PRICE_ID DA_SOURCE_PRICE_ID
			  FROM INTERCHANGE_TRANSACTION   T,
				   IT_COMMODITY              COMM,
				   INTERCHANGE_CONTRACT      C,
				   PURCHASING_SELLING_ENTITY PSE,
				   MARKET_PRICE              MP_SINK,
				   MARKET_PRICE              MP_SRC
			 WHERE COMM.COMMODITY_ALIAS = 'Transmission'
			   AND COMM.COMMODITY_ID = T.COMMODITY_ID
			   AND UPPER(T.AGREEMENT_TYPE) LIKE 'FTR%'
			   AND T.CONTRACT_ID IS NOT NULL
			   AND T.CONTRACT_ID <> 0
			   AND T.CONTRACT_ID = C.CONTRACT_ID
			   AND T.TRANSACTION_TYPE = 'Purchase'
			   AND T.TRANSACTION_INTERVAL = 'Hour'
			   AND T.BEGIN_DATE >= LOW_DATE
			   AND C.BILLING_ENTITY_ID = PSE.PSE_ID
			   AND T.SOURCE_ID = MP_SRC.POD_ID
			   AND MP_SRC.MARKET_TYPE = 'DayAhead'
			   AND MP_SRC.MARKET_PRICE_TYPE = 'Locational Marginal Price'
			   AND T.SINK_ID = MP_SINK.POD_ID
			   AND MP_SINK.MARKET_TYPE = 'DayAhead'
			   AND MP_SINK.MARKET_PRICE_TYPE = 'Locational Marginal Price'
			 GROUP BY PSE.PSE_NAME,
					  T.TRANSACTION_ID,
					  T.SC_ID,
					  MP_SINK.MARKET_PRICE_ID,
					  MP_SRC.MARKET_PRICE_ID
/
