CREATE OR REPLACE TRIGGER BILLING_CHARGE_DISPUTE_UPDATE
	BEFORE INSERT OR UPDATE OR DELETE ON BILLING_CHARGE_DISPUTE
	FOR EACH ROW
DECLARE
	v_IN_DISPUTE NUMBER;
BEGIN
	IF DELETING THEN
    	v_IN_DISPUTE := 0;

		UPDATE BILLING_STATEMENT
			SET IN_DISPUTE = v_IN_DISPUTE
		WHERE ENTITY_ID = :old.ENTITY_ID
			AND PRODUCT_ID = :old.PRODUCT_ID
			AND COMPONENT_ID = :old.COMPONENT_ID
			AND STATEMENT_TYPE = :old.STATEMENT_TYPE
			AND STATEMENT_STATE = :old.STATEMENT_STATE
			AND STATEMENT_DATE = :old.STATEMENT_DATE;
    ELSE
	    IF UPPER(:new.DISPUTE_STATUS) = 'NONE' OR UPPER(:new.DISPUTE_STATUS) = 'RESOLVED' OR UPPER(:new.DISPUTE_STATUS) = 'CANCELLED' THEN
			v_IN_DISPUTE := 0;
		ELSE
			v_IN_DISPUTE := 1;
		END IF;

		UPDATE BILLING_STATEMENT
			SET IN_DISPUTE = v_IN_DISPUTE
		WHERE ENTITY_ID = :new.ENTITY_ID
			AND PRODUCT_ID = :new.PRODUCT_ID
			AND COMPONENT_ID = :new.COMPONENT_ID
			AND STATEMENT_TYPE = :new.STATEMENT_TYPE
			AND STATEMENT_STATE = :new.STATEMENT_STATE
			AND STATEMENT_DATE = :new.STATEMENT_DATE;
	END IF;

EXCEPTION
       WHEN ERRS.e_TABLE_IS_MUTATING THEN
              NULL; -- updating BILLING_STATEMENT failed bc it was being
			   -- deleted too, so it doesnt' amtter that we couldn't update.
			   -- ignore

END BILLING_CHARGE_DISPUTE_UPDATE;
/
