CREATE OR REPLACE TRIGGER SRVCE_LOC_PROGRAM_DELETE
  BEFORE DELETE ON SERVICE_LOCATION_PROGRAM
  FOR EACH ROW
BEGIN
  	FOR v_REC IN
		(SELECT DP.*
		FROM DER_PROGRAM DP, DISTRIBUTED_ENERGY_RESOURCE DER
		WHERE DER.SERVICE_LOCATION_ID = :OLD.SERVICE_LOCATION_ID
			AND DP.DER_ID = DER.DER_ID
			AND DP.PROGRAM_ID = :OLD.PROGRAM_ID
			AND DP.BEGIN_DATE >= :OLD.BEGIN_DATE
			AND NVL(DP.END_DATE, CONSTANTS.HIGH_DATE) <= NVL(:OLD.END_DATE, CONSTANTS.HIGH_DATE))
	LOOP
		DELETE DER_PROGRAM
    	WHERE DER_ID = v_REC.DER_ID
        	AND BEGIN_DATE = v_REC.BEGIN_DATE;
	END LOOP;
EXCEPTION
	WHEN ERRS.e_TABLE_IS_MUTATING THEN
		LOGS.LOG_DEBUG('Ignoring a table is mutating exception on Service Location Program for SL_ID: ' 
			|| :OLD.SERVICE_LOCATION_ID);
END SRVCE_LOC_PROGRAM_DELETE;
/
