CREATE OR REPLACE TRIGGER SRVCE_LOC_PROGRAM_UPDATE
	BEFORE UPDATE ON SERVICE_LOCATION_PROGRAM  
	FOR EACH ROW
BEGIN
	FOR v_REC IN
		(SELECT DP.*
		FROM DER_PROGRAM DP, DISTRIBUTED_ENERGY_RESOURCE DER
		WHERE DER.SERVICE_LOCATION_ID = :OLD.SERVICE_LOCATION_ID
			AND DP.DER_ID = DER.DER_ID
			AND DP.PROGRAM_ID = :OLD.PROGRAM_ID
			AND DP.BEGIN_DATE >= :OLD.BEGIN_DATE
			AND NVL(DP.END_DATE, CONSTANTS.HIGH_DATE) <= NVL(:OLD.END_DATE, CONSTANTS.HIGH_DATE))
	LOOP
		IF :NEW.SERVICE_LOCATION_ID != :OLD.SERVICE_LOCATION_ID OR :NEW.PROGRAM_ID != :OLD.PROGRAM_ID THEN
			ERRS.RAISE(MSGCODES.c_ERR_CANNOT_ORPHAN_ENROLLMENT, 'Cannot change a Program''s availability at a Service Location when there are Resources enrolled in the Program.');
		ELSIF :NEW.BEGIN_DATE > v_REC.BEGIN_DATE OR NVL(:NEW.END_DATE, CONSTANTS.HIGH_DATE) < NVL(v_REC.END_DATE, CONSTANTS.HIGH_DATE) THEN
			ERRS.RAISE(MSGCODES.c_ERR_DATE_RANGE, 'Cannot change the date range of a Program''s availability at a Service Location to exclude the time in which Resources are enrolled in the Program.');
		END IF;
	END LOOP;
END SRVCE_LOC_PROGRAM_UPDATE;
/
