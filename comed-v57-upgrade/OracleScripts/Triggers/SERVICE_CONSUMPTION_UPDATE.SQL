CREATE OR REPLACE TRIGGER SERVICE_CONSUMPTION_UPDATE
	BEFORE INSERT OR UPDATE ON SERVICE_CONSUMPTION
	FOR EACH ROW
DECLARE
v_BILL_CYCLE_MONTH DATE;
BEGIN
	IF GA.ENABLE_CONSUMPTION_END_DATE THEN
		v_BILL_CYCLE_MONTH := TRUNC(:new.END_DATE, 'MONTH');
	ELSE
		v_BILL_CYCLE_MONTH := TRUNC(:new.BEGIN_DATE, 'MONTH');
	END IF;
	SELECT TRUNC(BILL_CYCLE_MONTH, 'MONTH')
	INTO :new.BILL_CYCLE_MONTH
	FROM BILL_CYCLE_PERIOD X
	WHERE X.BILL_CYCLE_ID =
		(SELECT NVL(D.BILL_CYCLE_ID, NVL(C.BILL_CYCLE_ID, 0))
		FROM SERVICE A, ACCOUNT_SERVICE B, ACCOUNT_BILL_CYCLE C, METER_BILL_CYCLE D
		WHERE A.SERVICE_ID = :new.SERVICE_ID
			AND B.ACCOUNT_SERVICE_ID = A.ACCOUNT_SERVICE_ID
			AND C.ACCOUNT_ID(+) = B.ACCOUNT_ID
			AND C.BEGIN_DATE <= :new.END_DATE
			AND NVL(C.END_DATE, :new.END_DATE) >= :new.BEGIN_DATE
			AND D.METER_ID(+) = B.METER_ID
			AND D.BEGIN_DATE <= :new.END_DATE
			AND NVL(D.END_DATE, :new.END_DATE) >= :new.BEGIN_DATE)
		AND v_BILL_CYCLE_MONTH BETWEEN X.BEGIN_DATE AND X.END_DATE;
EXCEPTION
	WHEN OTHERS THEN
		:new.BILL_CYCLE_MONTH := v_BILL_CYCLE_MONTH;
END SERVICE_CONSUMPTION_UPDATE;
/
