CREATE OR REPLACE TRIGGER ACCOUNT_ESP_DELETE
	AFTER DELETE ON ACCOUNT_ESP
	FOR EACH ROW
BEGIN
	IF NOT GA.ENABLE_SERVICE_RETENTION THEN
		DELETE SERVICE_STATE
		WHERE SERVICE_ID IN
			(SELECT DISTINCT(C.SERVICE_ID)
			FROM ACCOUNT_SERVICE A,
				PROVIDER_SERVICE B,
				SERVICE C
			WHERE A.ACCOUNT_ID = :old.ACCOUNT_ID
				AND B.ESP_ID = :old.ESP_ID
				AND C.ACCOUNT_SERVICE_ID = A.ACCOUNT_SERVICE_ID
				AND C.PROVIDER_SERVICE_ID = B.PROVIDER_SERVICE_ID)
		AND SERVICE_DATE BETWEEN :old.BEGIN_DATE AND NVL(:old.END_DATE,HIGH_DATE);

	END IF;
END ACCOUNT_ESP_DELETE;
/ 
