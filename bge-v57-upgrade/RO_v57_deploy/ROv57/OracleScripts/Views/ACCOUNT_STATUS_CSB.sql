CREATE OR REPLACE VIEW ACCOUNT_STATUS_CSB AS
(
SELECT A.ACCOUNT_ID, 		 
		A.BEGIN_DATE, 		 
		A.END_DATE,  			 
		A.STATUS_NAME	   
FROM (
		(WITH AST1 AS
		 (SELECT ACCOUNT_ID,
				 BEGIN_DATE,
				 NVL(END_DATE, DATE '9999-12-31') END_DATE,
				 STATUS_NAME,
				 CASE LAG(END_DATE) OVER(PARTITION BY ACCOUNT_ID, STATUS_NAME ORDER BY BEGIN_DATE, END_DATE) + 1
					 WHEN BEGIN_DATE THEN
					  0
					 ELSE
					  1
				 END WINDOW_RANK
		  FROM ACCOUNT_STATUS),
		AST2 AS
		 (SELECT ACCOUNT_ID,
				 BEGIN_DATE,
				 END_DATE,
				 STATUS_NAME,
				 SUM(WINDOW_RANK) OVER(PARTITION BY ACCOUNT_ID, STATUS_NAME ORDER BY BEGIN_DATE, END_DATE) PARTITIONED_GROUP
		  FROM AST1)
		SELECT ACCOUNT_ID, MIN(BEGIN_DATE) BEGIN_DATE, MAX(END_DATE) END_DATE, STATUS_NAME
		FROM AST2
		GROUP BY ACCOUNT_ID, STATUS_NAME, PARTITIONED_GROUP
		ORDER BY ACCOUNT_ID, BEGIN_DATE
		)
	) A
);
