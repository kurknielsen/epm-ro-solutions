CREATE OR REPLACE TRIGGER INVOICE_BEFORE
	BEFORE DELETE OR UPDATE ON INVOICE
	FOR EACH ROW

DECLARE
v_INVOICE_STATUS VARCHAR2(32);
BEGIN
	-- fail if the invoice is closed
	IF DELETING THEN
    	v_INVOICE_STATUS := :old.INVOICE_STATUS;
	ELSE
    	IF UPPER(SUBSTR(:old.INVOICE_STATUS,1,6)) = 'CLOSED' AND UPPER(SUBSTR(:new.INVOICE_STATUS,1,6)) = 'CLOSED' THEN
        	v_INVOICE_STATUS := :old.INVOICE_STATUS;
        ELSE
        	v_INVOICE_STATUS := 'NONE';
        END IF;
	END IF;
	IF UPPER(SUBSTR(v_INVOICE_STATUS,1,6)) = 'CLOSED' THEN
		-- invoice is closed, so cancel this operation with an exception
		ERRS.RAISE(MSGCODES.c_ERR_INVOICE_CLOSED);
	END IF;
END INVOICE_BEFORE;
/
