CREATE OR REPLACE TRIGGER INVOICE_USER_LINE_ITEM_UPDATE
	BEFORE INSERT OR UPDATE OR DELETE ON INVOICE_USER_LINE_ITEM
	FOR EACH ROW
BEGIN
	IF DELETING THEN
		UPDATE INVOICE	SET APPROVED_BY_ID = NULL, LAST_SENT_BY_ID = NULL
		WHERE ENTITY_ID = :old.ENTITY_ID
			AND STATEMENT_TYPE = :old.STATEMENT_TYPE
			AND STATEMENT_STATE = :old.STATEMENT_STATE
			AND BEGIN_DATE = :old.BEGIN_DATE;
	ELSE
		UPDATE INVOICE	SET APPROVED_BY_ID = NULL, LAST_SENT_BY_ID = NULL
		WHERE ENTITY_ID = :new.ENTITY_ID
			AND STATEMENT_TYPE = :new.STATEMENT_TYPE
			AND STATEMENT_STATE = :new.STATEMENT_STATE
			AND BEGIN_DATE = :new.BEGIN_DATE;
	END IF;

EXCEPTION
	WHEN ERRS.e_TABLE_IS_MUTATING THEN
		NULL; -- ignore - this means that both INVOICE and INVOICE_USER_LINE_ITEM
			-- are being deleted and the attempt to update INVOICE failed.  Since
			-- the row will be deleted anyway, it doesn't matter.

END INVOICE_USER_LINE_ITEM_UPDATE;
/
