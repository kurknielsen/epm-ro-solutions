CREATE OR REPLACE TRIGGER DER_PROGRAM_UPDATE
	BEFORE INSERT OR UPDATE ON DER_PROGRAM  
	FOR EACH ROW
DECLARE
	v_COUNT NUMBER;
BEGIN
	SELECT COUNT(SLP.SERVICE_LOCATION_ID)
	INTO v_COUNT
	FROM SERVICE_LOCATION_PROGRAM SLP, DISTRIBUTED_ENERGY_RESOURCE DER, PROGRAM_DER_TYPE PDT
	WHERE PDT.PROGRAM_ID = :NEW.PROGRAM_ID
		AND SLP.PROGRAM_ID = PDT.PROGRAM_ID
		AND DER.DER_ID = :NEW.DER_ID
		AND DER.SERVICE_LOCATION_ID = SLP.SERVICE_LOCATION_ID
		AND DER.DER_TYPE_ID = PDT.DER_TYPE_ID
		AND SLP.BEGIN_DATE <= :NEW.BEGIN_DATE
		AND NVL(SLP.END_DATE, CONSTANTS.HIGH_DATE) >= NVL(:NEW.END_DATE, CONSTANTS.HIGH_DATE)
		AND DER.BEGIN_DATE <= :NEW.BEGIN_DATE
		AND NVL(DER.END_DATE, CONSTANTS.HIGH_DATE) >= NVL(:NEW.END_DATE, CONSTANTS.HIGH_DATE);
	
	IF v_COUNT = 0 THEN
		ERRS.RAISE(MSGCODES.c_ERR_CANNOT_ORPHAN_ENROLLMENT, 'A Resource cannot be enrolled in a Program for a date range in which the Program is unavailable at its Service Location.');
	END IF;
END DER_PROGRAM_UPDATE;
/
