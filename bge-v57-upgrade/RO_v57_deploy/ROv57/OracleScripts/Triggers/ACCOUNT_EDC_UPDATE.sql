CREATE OR REPLACE TRIGGER ACCOUNT_EDC_UPDATE
	AFTER UPDATE ON ACCOUNT_EDC
	FOR EACH ROW

DECLARE
v_BEGIN_START DATE;
v_BEGIN_STOP DATE;
v_END_START DATE;
v_END_STOP DATE;

BEGIN

	IF NOT GA.ENABLE_SERVICE_RETENTION THEN
-- Determine the Begin and End Date Ranges reflecting the User Specified date modifications.
		BEGIN_END_START_STOP_RANGE(:old.BEGIN_DATE, :new.BEGIN_DATE, :old.END_DATE, :new.END_DATE, v_BEGIN_START, v_BEGIN_STOP, v_END_START, v_END_STOP);

		DELETE SERVICE_STATE
		WHERE SERVICE_ID IN
			(SELECT DISTINCT(C.SERVICE_ID)
			FROM ACCOUNT_SERVICE A,
				PROVIDER_SERVICE B,
				SERVICE C
			WHERE A.ACCOUNT_ID = :old.ACCOUNT_ID
				AND B.EDC_ID = :old.EDC_ID
				AND C.ACCOUNT_SERVICE_ID = A.ACCOUNT_SERVICE_ID
				AND C.PROVIDER_SERVICE_ID = B.PROVIDER_SERVICE_ID)
		AND (SERVICE_DATE BETWEEN v_BEGIN_START AND v_BEGIN_STOP
				OR SERVICE_DATE BETWEEN v_END_START AND v_END_STOP);

-- Trigger an Account Change to handle any Account EDC Name dependency.
		UPDATE ACCOUNT
		SET ENTRY_DATE = ENTRY_DATE
		WHERE ACCOUNT_ID = :new.ACCOUNT_ID;
	END IF;

END ACCOUNT_EDC_UPDATE;
/
 
