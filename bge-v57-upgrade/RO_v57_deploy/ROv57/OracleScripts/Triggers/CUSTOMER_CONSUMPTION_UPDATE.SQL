CREATE OR REPLACE TRIGGER CUSTOMER_CONSUMPTION_UPDATE
	BEFORE INSERT OR UPDATE ON CUSTOMER_CONSUMPTION
	FOR EACH ROW
DECLARE
v_BILL_CYCLE_MONTH DATE;
BEGIN
	IF GA.ENABLE_CONSUMPTION_END_DATE THEN
		v_BILL_CYCLE_MONTH := TRUNC(:new.END_DATE, 'MONTH');
	ELSE
		v_BILL_CYCLE_MONTH := TRUNC(:new.BEGIN_DATE, 'MONTH');
	END IF;
	SELECT TRUNC(B.BILL_CYCLE_MONTH, 'MONTH')
	INTO :new.BILL_CYCLE_MONTH
	FROM CUSTOMER_BILL_CYCLE A, BILL_CYCLE_PERIOD B
	WHERE A.CUSTOMER_ID = :new.CUSTOMER_ID
		AND B.BILL_CYCLE_ID = A.BILL_CYCLE_ID
		AND A.BEGIN_DATE <= :new.END_DATE
		AND NVL(A.END_DATE, :new.END_DATE) >= :new.BEGIN_DATE
		AND v_BILL_CYCLE_MONTH BETWEEN B.BEGIN_DATE AND B.END_DATE;
EXCEPTION
	WHEN OTHERS THEN
		:new.BILL_CYCLE_MONTH := v_BILL_CYCLE_MONTH;
END CUSTOMER_CONSUMPTION_UPDATE;
/
