CREATE OR REPLACE FUNCTION STATEMENT_AS_OF_DATE
	(
	p_ENTITY_ID IN NUMBER,
	p_PRODUCT_ID IN NUMBER,
	p_COMPONENT_ID IN NUMBER,
	p_STATEMENT_TYPE IN NUMBER,
	p_STATEMENT_STATE IN NUMBER,
	p_STATEMENT_DATE IN DATE,
	p_AS_OF_DATE IN DATE
	) RETURN DATE IS
--Revision: $Revision: 1.21 $

-- Answer the maximun as of date that is less than or equal to the argument as of date.

v_AS_OF_DATE DATE := LOW_DATE;

BEGIN

	IF GA.VERSION_STATEMENT THEN
		SELECT MAX(AS_OF_DATE)
		INTO v_AS_OF_DATE
		FROM BILLING_STATEMENT
		WHERE ENTITY_ID = p_ENTITY_ID
			AND PRODUCT_ID = p_PRODUCT_ID
			AND COMPONENT_ID = p_COMPONENT_ID
			AND STATEMENT_TYPE = p_STATEMENT_TYPE
			AND STATEMENT_STATE = p_STATEMENT_STATE
			AND STATEMENT_DATE = p_STATEMENT_DATE
			AND AS_OF_DATE <= p_AS_OF_DATE;
	END IF;

	RETURN v_AS_OF_DATE;

	EXCEPTION
		WHEN NO_DATA_FOUND THEN
			RETURN v_AS_OF_DATE;
		WHEN OTHERS THEN
			RAISE;

END STATEMENT_AS_OF_DATE;
/

