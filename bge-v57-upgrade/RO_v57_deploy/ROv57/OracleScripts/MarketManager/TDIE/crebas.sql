--------------------------------------------------------------------------------
-- DDL Statements for the TDIE objects
--------------------------------------------------------------------------------
-- Tables:
--      TDIE_300_EXCEPTION
--      TDIE_300_METER
--      TDIE_300_MPRN
--      TDIE_300_REGISTER
--      TDIE_300_USAGE_FACTOR
--      TDIE_AGG_CONSUMPTION
--      TDIE_AGG_CONSUMPTION_DLF
--      TDIE_AGG_CONSUMPTION_DLF_DTL
--      TDIE_AGG_GENERATION
--      TDIE_MESSAGE
--      TDIE_NIETD
--      TDIE_NIETD_DETAIL
--      TDIE_NIETD_UNDER_REVIEW
--      TDIE_SMO_CONSUMPTION
--      TDIE_34X_MPRN
--      TDIE_34X_MPRN_CHANNEL
--      TDIE_34X_INTERVAL
--      TDIE_34X_EXCEPTION
--      TDIE_DUOS_INVOICE
--      TDIE_DUOS_INVOICE_DETAIL
--      TDIE_DUOS_NI_INVOICE
--      TDIE_DUOS_NI_INVOICE_DETAIL
--      TDIE_TUOS_INVOICE
--      TDIE_TUOS_INVOICE_DETAIL
--      TDIE_TUOS_INVOICE_CHARGE_DTL
--      TDIE_UOS_INVOICE
--      TDIE_UOS_INVOICE_DETAIL
--      TDIE_TUOS_SUPPLY_UNIT_MAP
--      TDIE_TUOS_CODES
--      TDIE_EARN_ID_MPRN_SU_MAPPING
--------------------------------------------------------------------------------
PROMPT Create table TDIE_300_EXCEPTION...
CREATE TABLE TDIE_300_EXCEPTION
(
	TDIE_ID			NUMBER(9)		NOT NULL,
	EVENT_ID		NUMBER(18)		NOT NULL,
	IGNORE_ERROR	NUMBER(1)		NOT NULL,
    CONSTRAINT PK_TDIE_300_EXCEPTION PRIMARY KEY (TDIE_ID)
		USING INDEX 
		TABLESPACE NERO_INDEX
		STORAGE
		(
		INITIAL     128K
		NEXT        128K
		PCTINCREASE   0
		)
)
STORAGE
(
INITIAL     128K
NEXT        128K
PCTINCREASE   0
)
TABLESPACE NERO_DATA
/
--------------------------------------------------------------------------------
PROMPT Create table TDIE_300_METER...
CREATE TABLE TDIE_300_METER
(
	TDIE_ID					NUMBER(9)		NOT NULL,
	SERIAL_NUMBER 			VARCHAR2(11)	NOT NULL,
	METER_CATEGORY_CODE		VARCHAR2(20),
	METER_LOCATION_CODE		VARCHAR2(3),
	EXCHANGED_METER_REFERENCE 	VARCHAR2(18),
    CONSTRAINT PK_TDIE_300_METER PRIMARY KEY (TDIE_ID, SERIAL_NUMBER)
		USING INDEX 
		TABLESPACE NERO_INDEX
		STORAGE
		(
		INITIAL     128K
		NEXT        128K
		PCTINCREASE   0
		)
)
STORAGE
(
INITIAL     128K
NEXT        128K
PCTINCREASE   0
)
TABLESPACE NERO_DATA
/
-------------------------------------------------------------------------------- 	
PROMPT Create table TDIE_300_MPRN...
CREATE TABLE TDIE_300_MPRN
(
	TDIE_ID						NUMBER(9)	NOT NULL,
	DUOS_GROUP					VARCHAR2(4)	NOT NULL,
	LOAD_PROFILE_CODE			VARCHAR2(16),
	METER_POINT_STATUS_CODE		VARCHAR2(5)	NOT NULL,
	METER_CONFIGURATION_CODE 	VARCHAR2(10),	
	MP_BUSINESS_REFERENCE		VARCHAR2(35),
	KEYPAD_PREMISES_NUMBER		VARCHAR2(19),	
	TARIFF_CONFIGURATION_CODE	VARCHAR2(2),
	NETWORKS_REFERENCE_NUMBER	VARCHAR2(35),
	WITHDRAWAL_REASON_CODE		VARCHAR2(2),
	NO_READ_CODE				NUMBER(3),
	DEBIT_REESTIMATION			VARCHAR2(5),	
    CONSTRAINT PK_TDIE_300_MPRN PRIMARY KEY (TDIE_ID)
		USING INDEX 
		TABLESPACE NERO_INDEX
		STORAGE
		(
		INITIAL     128K
		NEXT        128K
		PCTINCREASE   0
		)
)
STORAGE
(
INITIAL     128K
NEXT        128K
PCTINCREASE   0
)
TABLESPACE NERO_DATA
/
--------------------------------------------------------------------------------
PROMPT Create table TDIE_300_REGISTER...
CREATE TABLE TDIE_300_REGISTER
(
	TDIE_ID							NUMBER(9)		NOT NULL,
	SERIAL_NUMBER 					VARCHAR2(11)		NOT NULL,
	METER_REGISTER_SEQUENCE			VARCHAR2(3)		NOT NULL,
	TIMESLOT_CODE					VARCHAR2(10)	NOT NULL,
	REGISTER_TYPE_CODE 				VARCHAR2(2)		NOT NULL,
	REGISTER_NODE_TYPE				VARCHAR2(16)	NOT NULL,
	UOM_CODE						VARCHAR2(3)		NOT NULL,
	PREVIOUS_READ_DATE				DATE,
	READ_REASON_CODE				VARCHAR2(2)		NOT NULL,
	READ_STATUS_CODE				VARCHAR2(4),
	READ_TYPE_CODE					VARCHAR2(2)		NOT NULL,
	METER_MULTIPLIER				NUMBER(12,5)	NOT NULL,
	PRE_DECIMAL_DETAILS				NUMBER(2),
	POST_DECIMAL_DETAILS			NUMBER(1),	
	CONSUMPTION						NUMBER(15,3),	
	READING_VALUE					NUMBER(15,3)	NOT NULL,
	ANNUALISED_ACTUAL_CONSUMPTION	NUMBER(18,6),
	ESTIMATED_USAGE_FACTOR			NUMBER(18,6),	
    CONSTRAINT PK_TDIE_300_REGISTER PRIMARY KEY (TDIE_ID, SERIAL_NUMBER, METER_REGISTER_SEQUENCE, TIMESLOT_CODE, REGISTER_TYPE_CODE, REGISTER_NODE_TYPE)
		USING INDEX 
		TABLESPACE NERO_INDEX
		STORAGE
		(
		INITIAL     128K
		NEXT        128K
		PCTINCREASE   0
		)
)
STORAGE
(
INITIAL     128K
NEXT        128K
PCTINCREASE   0
)
TABLESPACE NERO_DATA
/
-------------------------------------------------------------------------------- 
PROMPT Create table TDIE_300_USAGE_FACTOR...
CREATE TABLE TDIE_300_USAGE_FACTOR
(
	TDIE_ID					NUMBER(9)		NOT NULL,
	TIMESLOT_CODE 			VARCHAR2(10)	NOT NULL,
	USAGE_FACTOR_TYPE		VARCHAR2(1)		NOT NULL,
	EFFECTIVE_FROM_DATE 	DATE			NOT NULL,
	USAGE_FACTOR			NUMBER (15,8)	NOT NULL,
    CONSTRAINT PK_TDIE_300_USAGE_FACTOR PRIMARY KEY (TDIE_ID, TIMESLOT_CODE, USAGE_FACTOR_TYPE, EFFECTIVE_FROM_DATE)
		USING INDEX 
		TABLESPACE NERO_INDEX
		STORAGE
		(
		INITIAL     128K
		NEXT        128K
		PCTINCREASE   0
		)
)
STORAGE
(
INITIAL     128K
NEXT        128K
PCTINCREASE   0
)
TABLESPACE NERO_DATA
/

-------------------------------------------------------------------------------- 
PROMPT Create table TDIE_AGG_CONSUMPTION...
CREATE TABLE TDIE_AGG_CONSUMPTION(
   TDIE_ID                   NUMBER(9)    NOT NULL,
   INTERVAL_PERIOD_TIMESTAMP DATE         NOT NULL,
   AGGREGATED_CONSUMPTION    NUMBER(9,2)  NOT NULL,
   LA_AGGREGATED_CONSUMPTION NUMBER(9,2)  NOT NULL,
   UNDER_REVIEW              NUMBER(1),
   CONSTRAINT PK_TDIE_AGG_CONSUMPTION 
      PRIMARY KEY (TDIE_ID,
                   INTERVAL_PERIOD_TIMESTAMP)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_AGG_CONSUMPTION_DLF...
CREATE TABLE TDIE_AGG_CONSUMPTION_DLF(
   TDIE_DETAIL_ID            NUMBER(9)    NOT NULL,
   TDIE_ID                   NUMBER(9)    NOT NULL,
   DLF_CODE                  VARCHAR2(6)  NOT NULL,
   LOAD_PROFILE_CODE         VARCHAR2(3),  
   MPRN_TALLY                NUMBER(9)    NOT NULL,
   CONSTRAINT PK_TDIE_AGG_CONSUMPTION_DLF
      PRIMARY KEY (TDIE_DETAIL_ID)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_AGG_CONSUMPTION_DLF_DTL...
CREATE TABLE TDIE_AGG_CONSUMPTION_DLF_DTL(
   TDIE_DETAIL_ID            NUMBER(9)    NOT NULL,
   INTERVAL_PERIOD_TIMESTAMP DATE         NOT NULL,
   AGGREGATED_CONSUMPTION    NUMBER(9,2)  NOT NULL,
   LA_AGGREGATED_CONSUMPTION NUMBER(9,2),
   CONSTRAINT PK_AGG_CONSUMPTION_DLF_DTL
      PRIMARY KEY (TDIE_DETAIL_ID,
                   INTERVAL_PERIOD_TIMESTAMP)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_AGG_GENERATION...
CREATE TABLE TDIE_AGG_GENERATION(
   TDIE_ID                   NUMBER(9)    NOT NULL,
   INTERVAL_PERIOD_TIMESTAMP DATE         NOT NULL,
   METERED_GENERATION        NUMBER(9,2)  NOT NULL,
   LA_METERED_GENERATION     NUMBER(9,2)  NOT NULL,
   CONSTRAINT PK_TDIE_AGG_GENERATION
      PRIMARY KEY (TDIE_ID,
                   INTERVAL_PERIOD_TIMESTAMP)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_MESSAGE...
CREATE TABLE TDIE_MESSAGE(
   TDIE_ID                  NUMBER(9)    NOT NULL,
   MESSAGE_TYPE_CODE        VARCHAR2(5)  NOT NULL,
   LOCATION_ID              VARCHAR2(16) NOT NULL,
   SETTLEMENT_RUN_INDICATOR VARCHAR2(8),
   MESSAGE_DATE          	DATE         NOT NULL,
   END_PERIOD_TIME          DATE,
   MARKET_TIMESTAMP         DATE,
   RECIPIENT_ID             VARCHAR2(3),
   SENDER_ID                VARCHAR2(3),
   TX_REF_NUMBER            VARCHAR2(36),
   VERSION_NUMBER           VARCHAR2(9),
   SSAC                     VARCHAR2(1),
   PERCENT_CONS_ACT         NUMBER(3),
   PERCENT_MPRN_EST         NUMBER(3),
   SUPPLIER_MPID            VARCHAR2(3),
   PROCESS_ID               NUMBER(12),
   CONSTRAINT PK_TDIE_MESSAGE 
      PRIMARY KEY (TDIE_ID)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_NIETD...
CREATE TABLE TDIE_NIETD(
   TDIE_DETAIL_ID            NUMBER(9)    NOT NULL,
   TDIE_ID                   NUMBER(9)    NOT NULL,
   LOAD_PROFILE              VARCHAR2(16) NOT NULL,
   LINE_LOSS_FACTOR_ID       VARCHAR2(16) NOT NULL,
   LINE_LOSS_INDICATOR       VARCHAR2(1)  NOT NULL,
   IMP_EXP_INDICATOR         VARCHAR2(6)  NOT NULL,
   METER_VALUE_INDICATOR     VARCHAR2(3)  NOT NULL,
   UOS_TARIFF                VARCHAR2(16) NOT NULL,
   AGG_CODE                  VARCHAR2(1),
   METER_CONFIGURATION_CODE  VARCHAR2(16) NOT NULL,
   TIME_SLOT                 VARCHAR2(16) NOT NULL,
   CONSTRAINT PK_TDIE_NIETD
      PRIMARY KEY (TDIE_DETAIL_ID)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_NIETD_DETAIL...
CREATE TABLE TDIE_NIETD_DETAIL(
   TDIE_DETAIL_ID            NUMBER(9)   NOT NULL,
   SCHEDULE_DATE             DATE        NOT NULL,
   ENERGY_TYPE               VARCHAR2(1) NOT NULL,
   ENERGY                    NUMBER(9,3) NOT NULL,
   ACT_EST_INDICATOR         VARCHAR2(1) NOT NULL,
   CONSTRAINT PK_TDIE_NIETD_DETAIL
      PRIMARY KEY (TDIE_DETAIL_ID,
                   SCHEDULE_DATE,
                   ENERGY_TYPE)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_NIETD_UNDER_REVIEW...
CREATE TABLE TDIE_NIETD_UNDER_REVIEW(
   TDIE_ID                   NUMBER(9)    NOT NULL,
   SCHEDULE_DATE             DATE         NOT NULL,
   ENERGY_TYPE               VARCHAR2(1)    NOT NULL,
   CONSTRAINT PK_TDIE_NIETD_UNDER_REVIEW
      PRIMARY KEY (TDIE_ID,
                   SCHEDULE_DATE)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_SMO_CONSUMPTION...
CREATE TABLE TDIE_SMO_CONSUMPTION(
   TDIE_ID                   NUMBER(9)    NOT NULL,
   START_TIME                DATE         NOT NULL,
   END_TIME                  DATE         NOT NULL,
   MEASURED_QUANTITY         NUMBER(8,3)  NOT NULL,
   QUERY_FLAG                NUMBER(1)    NOT NULL,
   READING_DATA_STATUS       NUMBER(1)    NOT NULL,
   READING_NUMBER            NUMBER(2)    NOT NULL,
   NIEP 		     NUMBER(10,8),
   CONSTRAINT PK_TDIE_SMO_CONSUMPTION
      PRIMARY KEY (TDIE_ID,
                   START_TIME,
                   END_TIME)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/
-------------------------------------------------------------------------------- 


PROMPT Creating foreign key FK_TDIE_300_EXCEPTION_TDIE_MSG...
ALTER TABLE TDIE_300_EXCEPTION
   ADD CONSTRAINT FK_TDIE_300_EXCEPTION_TDIE_MSG 
   FOREIGN KEY (TDIE_ID) 
   REFERENCES TDIE_MESSAGE (TDIE_ID)
   ON DELETE CASCADE
/

PROMPT Creating foreign key FK_TDIE_300_EXCEPTION_EVENT...
ALTER TABLE TDIE_300_EXCEPTION
   ADD CONSTRAINT FK_TDIE_300_EXCEPTION_EVENT 
   FOREIGN KEY (EVENT_ID) 
   REFERENCES PROCESS_LOG_EVENT (EVENT_ID)
   ON DELETE CASCADE
/

PROMPT Creating foreign key FK_TDIE_300_METER_TDIE_MSG...
ALTER TABLE TDIE_300_METER
   ADD CONSTRAINT FK_TDIE_300_METER_TDIE_MSG 
   FOREIGN KEY (TDIE_ID) 
   REFERENCES TDIE_MESSAGE (TDIE_ID)
   ON DELETE CASCADE
/


PROMPT Creating foreign key FK_TDIE_300_MPRN_TDIE_MSG...
ALTER TABLE TDIE_300_MPRN
   ADD CONSTRAINT FK_TDIE_300_MPRN_TDIE_MSG 
   FOREIGN KEY (TDIE_ID) 
   REFERENCES TDIE_MESSAGE (TDIE_ID)
   ON DELETE CASCADE
/


PROMPT Creating foreign key FK_TDIE_300_REGISTER_TDIE_MSG...
ALTER TABLE TDIE_300_REGISTER
   ADD CONSTRAINT FK_TDIE_300_REGISTER_TDIE_MSG 
   FOREIGN KEY (TDIE_ID,SERIAL_NUMBER) 
   REFERENCES TDIE_300_METER (TDIE_ID,SERIAL_NUMBER)
   ON DELETE CASCADE
/


PROMPT Creating foreign key FK_TDIE_300_USG_FCTR_TDIE_MSG...
ALTER TABLE TDIE_300_USAGE_FACTOR
   ADD CONSTRAINT FK_TDIE_300_USG_FCTR_TDIE_MSG 
   FOREIGN KEY (TDIE_ID) 
   REFERENCES TDIE_MESSAGE (TDIE_ID)
   ON DELETE CASCADE
/


PROMPT Creating unique key AK_TDIE_MESSAGE...
ALTER TABLE TDIE_MESSAGE
   ADD CONSTRAINT AK_TDIE_MESSAGE 
   UNIQUE  (MESSAGE_TYPE_CODE,
            LOCATION_ID,
            SETTLEMENT_RUN_INDICATOR,
            MESSAGE_DATE) 
   USING INDEX TABLESPACE NERO_INDEX
/

PROMPT Creating indexes on TDIE_MESSAGE...
CREATE INDEX TDIE_MESSAGE_IX01
   ON TDIE_MESSAGE (MESSAGE_TYPE_CODE, SETTLEMENT_RUN_INDICATOR, MESSAGE_DATE)
STORAGE(INITIAL     128K
	     NEXT        128K
		  PCTINCREASE   0)
TABLESPACE NERO_INDEX 
/

CREATE INDEX TDIE_MESSAGE_IX02
   ON TDIE_MESSAGE (MESSAGE_DATE, LOCATION_ID, MESSAGE_TYPE_CODE)
STORAGE(INITIAL     128K
	     NEXT        128K
		  PCTINCREASE   0)
TABLESPACE NERO_INDEX 
/

PROMPT Creating foreign key FK_TDIE_MSG_PROC_LOG...
ALTER TABLE TDIE_MESSAGE
   ADD CONSTRAINT FK_TDIE_MSG_PROC_LOG 
   FOREIGN KEY (PROCESS_ID) 
   REFERENCES PROCESS_LOG (PROCESS_ID)
   ON DELETE SET NULL
/

PROMPT Creating check constraint CK_TDIE_MESSAGE_MSG_TYPE_CODE...
alter table TDIE_MESSAGE
  add constraint CK_TDIE_MESSAGE_MSG_TYPE_CODE
  check ((MESSAGE_TYPE_CODE IN ('591','595','596','598') AND
            SETTLEMENT_RUN_INDICATOR IN ('10','20','30','40','50'))
            OR
           (MESSAGE_TYPE_CODE IN ('N591','N595','N598') AND
            SETTLEMENT_RUN_INDICATOR IN ('D+1','D+4','M+4','M+13','ADHOC'))
			OR
           (MESSAGE_TYPE_CODE IN ('300','300S','300W','305','306','307','310','306W','307W','310W','320','332','320W','332W','N300','N300S','N300W','N320','N332','N306','N307','N310') AND
            SETTLEMENT_RUN_INDICATOR IS NULL))
/

PROMPT Creating foreign key FK_AGG_CONSUMPTION_TDIE_MSG...
ALTER TABLE TDIE_AGG_CONSUMPTION
   ADD CONSTRAINT FK_AGG_CONSUMPTION_TDIE_MSG 
   FOREIGN KEY (TDIE_ID) 
   REFERENCES TDIE_MESSAGE (TDIE_ID)
   ON DELETE CASCADE
/

PROMPT Creating unique key AK_TDIE_AGG_CONSUMPTION_DLF...
ALTER TABLE TDIE_AGG_CONSUMPTION_DLF                  
   ADD CONSTRAINT AK_TDIE_AGG_CONSUMPTION_DLF
   UNIQUE (TDIE_ID,
           DLF_CODE,
           LOAD_PROFILE_CODE) 
   USING INDEX TABLESPACE NERO_INDEX
/

PROMPT Creating foreign key FK_AGG_CONSUMPT_DLF_TDIE_MSG...
ALTER TABLE TDIE_AGG_CONSUMPTION_DLF                  
   ADD CONSTRAINT FK_AGG_CONSUMPT_DLF_TDIE_MSG 
   FOREIGN KEY (TDIE_ID) 
   REFERENCES TDIE_MESSAGE (TDIE_ID)
   ON DELETE CASCADE
/

PROMPT Creating foreign key FK_AGG_CON_DLF_DTL_AGG_CON_DLF...
ALTER TABLE TDIE_AGG_CONSUMPTION_DLF_DTL                  
   ADD CONSTRAINT FK_AGG_CON_DLF_DTL_AGG_CON_DLF 
   FOREIGN KEY (TDIE_DETAIL_ID) 
   REFERENCES TDIE_AGG_CONSUMPTION_DLF (TDIE_DETAIL_ID)
   ON DELETE CASCADE
/

PROMPT Creating foreign key FK_SMO_CONSUMPTION_TDIE_MSG...
ALTER TABLE TDIE_SMO_CONSUMPTION
   ADD CONSTRAINT FK_SMO_CONSUMPTION_TDIE_MSG 
   FOREIGN KEY (TDIE_ID) 
   REFERENCES TDIE_MESSAGE (TDIE_ID)
   ON DELETE CASCADE
/

PROMPT Creating foreign key FK_AGG_GENERATION_TDIE_MSG...
ALTER TABLE TDIE_AGG_GENERATION
   ADD CONSTRAINT FK_AGG_GENERATION_TDIE_MSG 
   FOREIGN KEY (TDIE_ID) 
   REFERENCES TDIE_MESSAGE (TDIE_ID)
   ON DELETE CASCADE
/

PROMPT Creating foreign key FK_NIETD_UNDER_REVIEW_TDIE_MSG...
ALTER TABLE TDIE_NIETD_UNDER_REVIEW
   ADD CONSTRAINT FK_NIETD_UNDER_REVIEW_TDIE_MSG 
   FOREIGN KEY (TDIE_ID) 
   REFERENCES TDIE_MESSAGE (TDIE_ID)
   ON DELETE CASCADE
/

PROMPT Creating foreign key FK_TDIE_NIETD_TDIE_MSG...
ALTER TABLE TDIE_NIETD
   ADD CONSTRAINT FK_TDIE_NIETD_TDIE_MSG 
   FOREIGN KEY (TDIE_ID) 
   REFERENCES TDIE_MESSAGE (TDIE_ID)
   ON DELETE CASCADE
/

PROMPT Creating foreign key FK_TDIE_NIETD_DTL_TDIE_NIETD...
ALTER TABLE TDIE_NIETD_DETAIL
   ADD CONSTRAINT FK_TDIE_NIETD_DTL_TDIE_NIETD 
   FOREIGN KEY (TDIE_DETAIL_ID) 
   REFERENCES TDIE_NIETD (TDIE_DETAIL_ID)
   ON DELETE CASCADE
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_34X_MPRN...
CREATE TABLE TDIE_34X_MPRN(
   TDIE_MPRN_MSG_ID                      NUMBER(9)    NOT NULL,
   MPRN                                  VARCHAR2(11) NOT NULL,
   READ_DATE                             DATE         NOT NULL,
   MARKET_TIMESTAMP                      DATE         NOT NULL,
   MESSAGE_TYPE_CODE                     VARCHAR2(5)  NOT NULL,
   TX_REF_NUMBER                         VARCHAR2(36) NOT NULL,
   RECIPIENT_CID                         VARCHAR2(3)  NOT NULL,
   SENDER_CID                            VARCHAR2(3)  NOT NULL,
   SUPPLIER_MPID                         VARCHAR2(3),
   VERSION_NUMBER                        VARCHAR2(9)  NOT NULL,
   GENERATOR_MPID						 VARCHAR2(6),
   GENERATOR_UNITID						 VARCHAR2(10),
   TRANSFORMER_LOSS_FACTOR		 		 NUMBER(6,4),
   ALERT_FLAG				 			 VARCHAR2(5),
   READING_REPLACEMENT_VER_NUM	 	 	 VARCHAR2(5),
   PROCESS_ID                            NUMBER(12),
   CONSTRAINT PK_TDIE_34X_MPRN 
      PRIMARY KEY (TDIE_MPRN_MSG_ID)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/


PROMPT Creating unique key AK_TDIE_34X_MPRN...
ALTER TABLE TDIE_34X_MPRN
   ADD CONSTRAINT AK_TDIE_34X_MPRN 
   UNIQUE  (MPRN,
            READ_DATE,
            MARKET_TIMESTAMP,
			GENERATOR_UNITID) 
   USING INDEX TABLESPACE NERO_INDEX
/

PROMPT Creating foreign key FK_34X_MPRN_PROC_LOG...
ALTER TABLE TDIE_34X_MPRN
   ADD CONSTRAINT FK_34X_MPRN_PROC_LOG 
   FOREIGN KEY (PROCESS_ID) 
   REFERENCES PROCESS_LOG (PROCESS_ID)
   ON DELETE SET NULL
/

PROMPT Creating check constraint CK_TDIE_34X_MPRN_MSG_TYPE_CODE...
ALTER TABLE TDIE_34X_MPRN
   ADD CONSTRAINT CK_TDIE_34X_MPRN_MSG_TYPE_CODE
   CHECK  (MESSAGE_TYPE_CODE IN ('341','342','N341','N342'))
/


--------------------------------------------------------------------------------
PROMPT Create table TDIE_34X_MPRN_CHANNEL...
CREATE TABLE TDIE_34X_MPRN_CHANNEL(
   TDIE_MPRN_CHANNEL_ID	  	NUMBER(9)		NOT NULL,
   TDIE_MPRN_MSG_ID	     	NUMBER(9)		NOT NULL,
   SERIAL_NUMBER	        VARCHAR2(11)	NOT NULL,
   REGISTER_TYPE_CODE	  	VARCHAR2(2)		NOT NULL,
   METER_CATEGORY_CODE	  	VARCHAR2(20),
   METERING_INTERVAL	    NUMBER(6)		NOT NULL,
   UOM_CODE	              	VARCHAR2(3)		NOT NULL,
   CONSTRAINT PK_TDIE_34X_MPRN_CHANNEL
      PRIMARY KEY (TDIE_MPRN_CHANNEL_ID)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

PROMPT Creating unique key AK_TDIE_34X_MPRN_CHANNEL...
ALTER TABLE TDIE_34X_MPRN_CHANNEL
   ADD CONSTRAINT AK_TDIE_34X_MPRN_CHANNEL 
   UNIQUE  (TDIE_MPRN_MSG_ID,
            SERIAL_NUMBER,
            REGISTER_TYPE_CODE) 
   USING INDEX TABLESPACE NERO_INDEX
/

PROMPT Creating foreign key FK_34X_CHANNEL_34X_MPRN...
ALTER TABLE TDIE_34X_MPRN_CHANNEL
   ADD CONSTRAINT FK_34X_CHANNEL_34X_MPRN 
   FOREIGN KEY (TDIE_MPRN_MSG_ID) 
   REFERENCES TDIE_34X_MPRN (TDIE_MPRN_MSG_ID)
   ON DELETE CASCADE
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_34X_INTERVAL...
CREATE TABLE TDIE_34X_INTERVAL(
   TDIE_MPRN_CHANNEL_ID	       	NUMBER(9)	NOT NULL,
   INTERVAL_PERIOD_TIMESTAMP	DATE		NOT NULL,
   INTERVAL_STATUS_CODE	       	VARCHAR2(4)	NOT NULL,
   INTERVAL_VALUE	        	NUMBER(9,3)	NOT NULL,
   NET_ACTIVE_DEMAND_VALUE		NUMBER(15,5),
   CONSTRAINT PK_TDIE_34X_INTERVAL
      PRIMARY KEY (TDIE_MPRN_CHANNEL_ID,
                   INTERVAL_PERIOD_TIMESTAMP)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

PROMPT Creating foreign key FK_34X_INTERVAL_34X_CHANNEL...
ALTER TABLE TDIE_34X_INTERVAL
   ADD CONSTRAINT FK_34X_INTERVAL_34X_CHANNEL 
   FOREIGN KEY (TDIE_MPRN_CHANNEL_ID) 
   REFERENCES TDIE_34X_MPRN_CHANNEL (TDIE_MPRN_CHANNEL_ID)
   ON DELETE CASCADE
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_34X_EXCEPTION...
CREATE TABLE TDIE_34X_EXCEPTION(
   TDIE_MPRN_MSG_ID	NUMBER(9) 	NOT NULL,
   EVENT_ID	        NUMBER(18) 	NOT NULL,
   IGNORE_ERROR       	NUMBER(1) 	DEFAULT 0 NOT NULL,
   CONSTRAINT PK_TDIE_34X_EXCEPTION
      PRIMARY KEY (TDIE_MPRN_MSG_ID)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

PROMPT Creating foreign key FK_34X_EXCEPTION_34X_MPRN...
ALTER TABLE TDIE_34X_EXCEPTION
   ADD CONSTRAINT FK_34X_EXCEPTION_34X_MPRN 
   FOREIGN KEY (TDIE_MPRN_MSG_ID) 
   REFERENCES TDIE_34X_MPRN (TDIE_MPRN_MSG_ID)
   ON DELETE CASCADE
/

PROMPT Creating foreign key FK_34X_EXCEPTION_PROC_LOG...
ALTER TABLE TDIE_34X_EXCEPTION
   ADD CONSTRAINT FK_34X_EXCEPTION_PROC_LOG 
   FOREIGN KEY (EVENT_ID) 
   REFERENCES PROCESS_LOG_EVENT (EVENT_ID)
   ON DELETE SET NULL
/


--------------------------------------------------------------------------------
PROMPT Create table TDIE_DUOS_INVOICE...
CREATE TABLE TDIE_DUOS_INVOICE(
   INVOICE_NUMBER            VARCHAR2(12)   NOT NULL,
   SENDER_CID                VARCHAR2(3)    NOT NULL,
   RECIPIENT_CID             VARCHAR2(3)    NOT NULL,
   MARKET_TIMESTAMP          DATE           NOT NULL,
   CONTROL_TOTAL             NUMBER         NOT NULL,
   TOTAL_RECORDS             NUMBER         DEFAULT 0 NOT NULL,
   NET_CHARGE_AMT_IMPORTED   NUMBER         DEFAULT 0 NOT NULL,
   GROSS_CHARGE_AMT_IMPORTED NUMBER         DEFAULT 0 NOT NULL,
   MPRN_COUNT				    NUMBER			DEFAULT 0 NOT NULL,
   RECORDS_IMPORTED          NUMBER         DEFAULT 0 NOT NULL,
   IMPORT_TIMESTAMP          TIMESTAMP      DEFAULT SYSTIMESTAMP NOT NULL,
   FILE_NAME                 VARCHAR2(1000) DEFAULT 'n/a' NOT NULL,
   PROCESS_ID                NUMBER(12),
   RETAIL_INVOICE_ID         NUMBER(9),
   CONSTRAINT PK_TDIE_DUOS_INVOICE 
      PRIMARY KEY (INVOICE_NUMBER)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

PROMPT Creating foreign key FK_TDIE_DUOS_INVOICE_PROC_LOG...
ALTER TABLE TDIE_DUOS_INVOICE
   ADD CONSTRAINT FK_TDIE_DUOS_INVOICE_PROC_LOG 
   FOREIGN KEY (PROCESS_ID) 
   REFERENCES PROCESS_LOG (PROCESS_ID)
   ON DELETE SET NULL
/
/*
PROMPT Creating foreign key FK_TDIE_DUOS_INV_RETAIL_INV...
ALTER TABLE TDIE_DUOS_INVOICE
   ADD CONSTRAINT FK_TDIE_DUOS_INV_RETAIL_INV 
   FOREIGN KEY (RETAIL_INVOICE_ID) 
   REFERENCES RETAIL_INVOICE (INVOICE_ID)
   ON DELETE SET NULL
/
*/
--------------------------------------------------------------------------------
PROMPT Create table TDIE_DUOS_INVOICE_DETAIL...
CREATE TABLE TDIE_DUOS_INVOICE_DETAIL(
   INVOICE_NUMBER            VARCHAR2(12)   NOT NULL,
   INVOICE_ITEM_NUMBER       NUMBER         NOT NULL,
   MPRN                      VARCHAR2(11)   NOT NULL,
   ADJUSTED_REFERENCE        NUMBER,
   INVOICE_TYPE              VARCHAR2(2)    NOT NULL,
   DUOS_GROUP                VARCHAR2(4)    NOT NULL,
   BILLING_BEGIN_DATE        DATE           NOT NULL,
   BILLING_END_DATE          DATE           NOT NULL,
   ENERGY_CONSUMPTION_DAY    NUMBER,
   ENERGY_CHARGE_DAY         NUMBER,
   ENERGY_CONSUMPTION_NIGHT  NUMBER,
   ENERGY_CHARGE_NIGHT       NUMBER,
   ENERGY_CONSUMPTION_24HR   NUMBER,
   ENERGY_CHARGE_24HR        NUMBER,
   STANDING_CHARGE           NUMBER,
   CAPACITY_CHARGE           NUMBER,
   MAX_IMPORT_CAPACITY       NUMBER,
   MAX_KVA                   NUMBER,
   MIC_SURCHARGE             NUMBER,
   REACTIVE_ENERGY           NUMBER,
   POWER_FACTOR_SURCHARGE    NUMBER,
   NET_AMOUNT                NUMBER,
   GROSS_AMOUNT              NUMBER,
   CONSTRAINT PK_TDIE_DUOS_INVOICE_DETAIL 
      PRIMARY KEY (INVOICE_ITEM_NUMBER)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

PROMPT Creating foreign key FK_TDIE_DUOS_INV_DTL_DUOS_INV...
ALTER TABLE TDIE_DUOS_INVOICE_DETAIL
   ADD CONSTRAINT FK_TDIE_DUOS_INV_DTL_DUOS_INV 
   FOREIGN KEY (INVOICE_NUMBER) 
   REFERENCES TDIE_DUOS_INVOICE (INVOICE_NUMBER)
   ON DELETE CASCADE
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_DUOS_NI_INVOICE...
CREATE TABLE TDIE_DUOS_NI_INVOICE(
   INVOICE_NUMBER           VARCHAR2(12)   NOT NULL,
   PROVIDER                 VARCHAR2(16)   NOT NULL,
   SUPPLIER                 VARCHAR2(16)   NOT NULL,
   MARKET_TIMESTAMP         DATE           NOT NULL,
   TOTAL_ITEMISED_LINES     NUMBER         DEFAULT 0 NOT NULL,
   RECORDS_IMPORTED         NUMBER         DEFAULT 0 NOT NULL,
	MPRN_COUNT			     	 NUMBER			 DEFAULT 0 NOT NULL,
	IMPORTED_REVENUE         NUMBER         DEFAULT 0 NOT NULL,
   REVENUE_EXCL_VAT         NUMBER         DEFAULT 0 NOT NULL,
   REVENUE_INC_VAT          NUMBER         DEFAULT 0 NOT NULL,
   IMPORT_TIMESTAMP         TIMESTAMP(6)   DEFAULT SYSTIMESTAMP NOT NULL,
   FILE_NAME                VARCHAR2(1000) DEFAULT 'n/a' NOT NULL,
   PROCESS_ID               NUMBER(12),
   RETAIL_INVOICE_ID        NUMBER(9),
   CONSTRAINT PK_TDIE_DUOS_NI_INVOICE 
      PRIMARY KEY (INVOICE_NUMBER)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

PROMPT Creating foreign key FK_TDIE_DUOS_NI_INV_PROC_LOG...
ALTER TABLE TDIE_DUOS_NI_INVOICE
   ADD CONSTRAINT FK_TDIE_DUOS_NI_INV_PROC_LOG 
   FOREIGN KEY (PROCESS_ID) 
   REFERENCES PROCESS_LOG (PROCESS_ID)
   ON DELETE SET NULL
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_DUOS_NI_INVOICE_DETAIL...
CREATE TABLE TDIE_DUOS_NI_INVOICE_DETAIL(
   INVOICE_NUMBER            VARCHAR2(12)   NOT NULL,
   ITEM_NUMBER               NUMBER         NOT NULL,
   POD_ID                    VARCHAR2(11)   NOT NULL,
   ADJUST_REF                NUMBER,
   INVOICE_TYPE              VARCHAR2(2)    NOT NULL,
   DUOS_GROUP                VARCHAR2(4)    NOT NULL,
   BILLING_BEGIN_DATE        DATE           NOT NULL,
   BILLING_END_DATE          DATE           NOT NULL,
   RATE_CATEGORY             VARCHAR2(5)    NOT NULL,
   STAND_CHARGE				  NUMBER,
	UNR_VOLUME					  NUMBER,					
	UNR_CHARGE				     NUMBER,
	D01_VOLUME				     NUMBER,
	D01_CHARGE				     NUMBER,
	N01_VOLUME					  NUMBER,
	N01_CHARGE					  NUMBER,
	D02_VOLUME					  NUMBER,
	D02_CHARGE					  NUMBER,
	N02_VOLUME					  NUMBER,
	N02_CHARGE					  NUMBER,
	N03_VOLUME					  NUMBER,
	N03_CHARGE					  NUMBER,
	N04_VOLUME					  NUMBER,
	N04_CHARGE					  NUMBER,
	HT1_VOLUME				     NUMBER,
	HT1_CHARGE				     NUMBER,
	HT2_VOLUME				     NUMBER,
	HT2_CHARGE				     NUMBER,
	HT3_VOLUME				     NUMBER,
	HT3_CHARGE				     NUMBER,
	W1_VOLUME				     NUMBER,
	W1_CHARGE				     NUMBER,
	W2_VOLUME				     NUMBER,
	W2_CHARGE				     NUMBER,
	FR1_VOLUME				     NUMBER,
	FR1_CHARGE				     NUMBER,
	FR2_VOLUME				     NUMBER,
	FR2_CHARGE				     NUMBER,
	FR3_VOLUME				     NUMBER,
	FR3_CHARGE				     NUMBER,
	FR4_VOLUME				     NUMBER,
	FR4_CHARGE				     NUMBER,
	KP5_VOLUME				     NUMBER,
	KP5_CHARGE				     NUMBER,
	KP6_VOLUME				     NUMBER,
	KP6_CHARGE				     NUMBER,
	KP7_VOLUME				     NUMBER,
	KP7_CHARGE				     NUMBER,
	KP8_VOLUME				     NUMBER,
	KP8_CHARGE				     NUMBER,
	R21_VOLUME				     NUMBER,
	R21_CHARGE				     NUMBER,
	R22_VOLUME				     NUMBER,
	R22_CHARGE				     NUMBER,
	R23_VOLUME				     NUMBER,
	R23_CHARGE				     NUMBER,
	R24_VOLUME				     NUMBER,
	R24_CHARGE				     NUMBER,
	R25_VOLUME				     NUMBER,
	R25_CHARGE				     NUMBER,
	UNMTRD_VOLUME			     NUMBER,
	UNMTRD_CHARGE			     NUMBER,
	SMO_VOLUME				     NUMBER,
	SMO_CHARGE				     NUMBER,			
	NFD_VOLUME				     NUMBER,
	NFD_CHARGE				     NUMBER,
	DJD_VOLUME				     NUMBER,		
	DJD_CHARGE				     NUMBER,
	NKP_VOLUME				     NUMBER,
	NKP_CHARGE				     NUMBER,
	DJPK_VOLUME				     NUMBER,
	DJPK_CHARGE				     NUMBER,
	EW_VOLUME				     NUMBER,
	EW_CHARGE				     NUMBER,
	NT_VOLUME				     NUMBER,
	NT_CHARGE				     NUMBER,
	RPC_VOLUME				     NUMBER,
	RPC_CHARGE				     NUMBER,
	CSC_VOLUME				     NUMBER,
	CSC_CHARGE				     NUMBER,
	MIC_VOLUME				     NUMBER,
	MIC_CHARGE				     NUMBER,
	R26_VOLUME				     NUMBER,
	R26_CHARGE				     NUMBER,	
	TOTAL_REVENUE			     NUMBER,
	REVENUE_INC_VAT		     NUMBER,
   CONSTRAINT PK_TDIE_DUOS_NI_INVOICE_DETAIL 
      PRIMARY KEY (ITEM_NUMBER)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

PROMPT Creating foreign key FK_TDIE_DUOS_NI_INV_DTL_DUOS...
ALTER TABLE TDIE_DUOS_NI_INVOICE_DETAIL
   ADD CONSTRAINT FK_TDIE_DUOS_NI_INV_DTL_DUOS 
   FOREIGN KEY (INVOICE_NUMBER) 
   REFERENCES TDIE_DUOS_NI_INVOICE (INVOICE_NUMBER)
   ON DELETE CASCADE
/


--------------------------------------------------------------------------------
PROMPT Create table TDIE_UOS_INVOICE...
CREATE TABLE TDIE_UOS_INVOICE(
   INVOICE_NUMBER               VARCHAR2(12)   NOT NULL,
   SENDER_CID                   VARCHAR2(16)    NOT NULL,
   RECIPIENT_CID                VARCHAR2(16)    NOT NULL,
   MARKET_TIMESTAMP             DATE           NOT NULL,
   DUE_DATE                     DATE           NOT NULL,
   TOTAL_CONSUMPTION            NUMBER         DEFAULT 0 NOT NULL,
   TOTAL_CSC                    NUMBER         DEFAULT 0 NOT NULL,
   TOTAL_REACTIVE               NUMBER         DEFAULT 0 NOT NULL,
   TOTAL_STANDING_CHARGE        NUMBER         DEFAULT 0 NOT NULL,
   TOTAL_TRANSMISSION_REBATE    NUMBER         DEFAULT 0 NOT NULL,
   TOTAL_AD_HOC                 NUMBER         DEFAULT 0 NOT NULL,
   TOTAL_CONSUMPTION_ADJUSTMENT NUMBER         DEFAULT 0 NOT NULL,
   TOTAL_VAT                    NUMBER         DEFAULT 0 NOT NULL,
   TOTAL_CANCELED               NUMBER         DEFAULT 0 NOT NULL,
   TOTAL_CONSUMPTION_KWH        NUMBER         DEFAULT 0 NOT NULL,
   TOTAL_DETAIL_LINES           NUMBER         DEFAULT 0 NOT NULL,
   NET_CHARGE_AMT_IMPORTED      NUMBER         DEFAULT 0 NOT NULL,
   GROSS_CHARGE_AMT_IMPORTED    NUMBER         DEFAULT 0 NOT NULL,
   MPRN_COUNT                   NUMBER         DEFAULT 0 NOT NULL,
   RECORDS_IMPORTED             NUMBER         DEFAULT 0 NOT NULL,
   IMPORT_TIMESTAMP             TIMESTAMP      DEFAULT SYSTIMESTAMP NOT NULL,
   FILE_NAME                    VARCHAR2(1000) DEFAULT 'n/a' NOT NULL,
   PROCESS_ID                   NUMBER(12),
   RETAIL_INVOICE_ID            NUMBER(9),
   CONSTRAINT PK_TDIE_UOS_INVOICE 
      PRIMARY KEY (INVOICE_NUMBER, SENDER_CID)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

PROMPT Creating foreign key FK_TDIE_UOS_INVOICE_PROC_LOG...
ALTER TABLE TDIE_UOS_INVOICE
   ADD CONSTRAINT FK_TDIE_UOS_INVOICE_PROC_LOG 
   FOREIGN KEY (PROCESS_ID) 
   REFERENCES PROCESS_LOG (PROCESS_ID)
   ON DELETE SET NULL
/
/*
PROMPT Creating foreign key FK_TDIE_UOS_INV_RETAIL_INV...
ALTER TABLE TDIE_UOS_INVOICE
   ADD CONSTRAINT FK_TDIE_UOS_INV_RETAIL_INV 
   FOREIGN KEY (RETAIL_INVOICE_ID) 
   REFERENCES RETAIL_INVOICE (INVOICE_ID)
   ON DELETE SET NULL
/
*/
--------------------------------------------------------------------------------
PROMPT Create table TDIE_UOS_INVOICE_DETAIL...
CREATE TABLE TDIE_UOS_INVOICE_DETAIL(
   INVOICE_NUMBER            VARCHAR2(12)   NOT NULL,
   SENDER_CID                VARCHAR2(16)    NOT NULL,
   RECORD_TYPE               VARCHAR2(11)   NOT NULL,
   MPRN                      VARCHAR2(11)   NOT NULL,
   METER_ID_SERIAL_NUMBER    VARCHAR2(16),
   START_DATE                DATE           NOT NULL,
   END_DATE                  DATE           NOT NULL,
   TIMESLOT_CODE             VARCHAR2(10),
   UNIT_OF_MEASURE           VARCHAR2(16),
   START_READ                NUMBER,
   START_READ_TYPE           VARCHAR2(1),
   END_READ                  NUMBER,
   END_READ_TYPE             VARCHAR2(1),
   TOTAL_UNITS               NUMBER,
   ESTIMATED_UNITS           NUMBER,
   UOS_TARIFF                VARCHAR2(10),
   RATE                      NUMBER         NOT NULL,
   CHARGE                    NUMBER         NOT NULL,
   LAST_ACTUAL_READ_VALUE    NUMBER,
   LAST_ACTUAL_READ_DATE     DATE)
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

PROMPT Creating index TDIE_UOS_INVOICE_DETAIL_IX01...
CREATE INDEX TDIE_UOS_INVOICE_DETAIL_IX01 
   ON TDIE_UOS_INVOICE_DETAIL (INVOICE_NUMBER, 
                               SENDER_CID, 
                               RECORD_TYPE, 
                               MPRN, 
                               METER_ID_SERIAL_NUMBER, 
                               START_DATE, 
                               END_DATE, 
                               TIMESLOT_CODE) 
STORAGE(INITIAL     128K
	     NEXT        128K
		  PCTINCREASE   0)
TABLESPACE NERO_INDEX 
/


PROMPT Creating foreign key FK_TDIE_UOS_INV_DTL_UOS_INV...
ALTER TABLE TDIE_UOS_INVOICE_DETAIL
   ADD CONSTRAINT FK_TDIE_UOS_INV_DTL_UOS_INV 
   FOREIGN KEY (INVOICE_NUMBER, SENDER_CID) 
   REFERENCES TDIE_UOS_INVOICE (INVOICE_NUMBER, SENDER_CID)
   ON DELETE CASCADE
/


--------------------------------------------------------------------------------
PROMPT Create table TDIE_TUOS_INVOICE...
CREATE TABLE TDIE_TUOS_INVOICE(
   INVOICE_NUMBER               VARCHAR2(12)   NOT NULL,
   INVOICE_NAME                 VARCHAR2(64),
   INVOICE_TYPE                 VARCHAR2(64),
   INVOICE_START_DATE           DATE,
   INVOICE_END_DATE             DATE,
   INVOICE_STATUS               VARCHAR2(64),
   INVOICE_DATE                 DATE,
   INVOICE_DUE_DATE             DATE,
   CUSTOMER_ID                  VARCHAR2(64),
   CUSTOMER_CATEGORY            VARCHAR2(64),
   CUSTOMER_TYPE                VARCHAR2(64),
   CUSTOMER_CODE                VARCHAR2(64),
   CUSTOMER_NAME                VARCHAR2(64),   
   NET_CHARGE_AMT_IMPORTED      NUMBER         DEFAULT 0 NOT NULL,
   GROSS_CHARGE_AMT_IMPORTED    NUMBER         DEFAULT 0 NOT NULL,
   MPRN_COUNT                   NUMBER         DEFAULT 0 NOT NULL,
   SUPPLY_UNIT_COUNT            NUMBER         DEFAULT 0 NOT NULL,
   RECORDS_IMPORTED             NUMBER         DEFAULT 0 NOT NULL,
   IMPORT_TIMESTAMP             TIMESTAMP      DEFAULT SYSTIMESTAMP NOT NULL,
   FILE_NAME                    VARCHAR2(1000) DEFAULT 'n/a' NOT NULL,
   PROCESS_ID                   NUMBER(12),
   RETAIL_INVOICE_ID            NUMBER(9),
   CONSTRAINT PK_TDIE_TUOS_INVOICE 
      PRIMARY KEY (INVOICE_NUMBER)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

PROMPT Creating foreign key FK_TDIE_TUOS_INVOICE_PROC_LOG...
ALTER TABLE TDIE_TUOS_INVOICE
   ADD CONSTRAINT FK_TDIE_TUOS_INVOICE_PROC_LOG 
   FOREIGN KEY (PROCESS_ID) 
   REFERENCES PROCESS_LOG (PROCESS_ID)
   ON DELETE SET NULL
/
/*
PROMPT Creating foreign key FK_TDIE_TUOS_INV_RETAIL_INV...
ALTER TABLE TDIE_TUOS_INVOICE
   ADD CONSTRAINT FK_TDIE_TUOS_INV_RETAIL_INV 
   FOREIGN KEY (RETAIL_INVOICE_ID) 
   REFERENCES RETAIL_INVOICE (INVOICE_ID)
   ON DELETE SET NULL
/
*/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_TUOS_INVOICE_DETAIL...
CREATE TABLE TDIE_TUOS_INVOICE_DETAIL(
   INVOICE_NUMBER            VARCHAR2(12)     NOT NULL,
   ACCOUNT_XID               NUMBER           NOT NULL,
   METER_NAME                VARCHAR2(128)     NOT NULL,
   ACCOUNT_CATEGORY          VARCHAR2(64),
   ACCOUNT_TYPE              VARCHAR2(64),
   ACCOUNT_CODE              VARCHAR2(64),
   ACCOUNT_NAME              VARCHAR2(64),
   METER_XID                 NUMBER,
   METER_CATEGORY            VARCHAR2(64),
   METER_TYPE                VARCHAR2(64),
   METER_CODE                VARCHAR2(64),
   BILL_NAME                 VARCHAR2(64),
   BILL_CONTACT              VARCHAR2(1000),
   BILL_ADDRESS1             VARCHAR2(1000),
   BILL_ADDRESS2             VARCHAR2(1000),
   BILL_CITY                 VARCHAR2(1000),
   BILL_REGION               VARCHAR2(1000),
   BILL_COUNTRY              VARCHAR2(1000),
   BILL_POSTAL_CODE          VARCHAR2(64),
   MPRN                      VARCHAR2(64),
   SUPPLY_UNIT               VARCHAR2(64),
   CONSTRAINT PK_TDIE_TUOS_INVOICE_DETAIL  
      PRIMARY KEY (INVOICE_NUMBER,
                   ACCOUNT_XID,
                   METER_NAME)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

PROMPT Creating foreign key FK_TDIE_UOS_INV_DTL_UOS_INV...
ALTER TABLE TDIE_TUOS_INVOICE_DETAIL
   ADD CONSTRAINT FK_TDIE_TUOS_INV_DTL_TUOS_INV 
   FOREIGN KEY (INVOICE_NUMBER) 
   REFERENCES TDIE_TUOS_INVOICE (INVOICE_NUMBER)
   ON DELETE CASCADE
/

PROMPT Creating check constraint CHK_TUOS_INV_DTL_MPRN_SUPPLY...
ALTER TABLE TDIE_TUOS_INVOICE_DETAIL
   ADD CONSTRAINT CHK_TUOS_INV_DTL_MPRN_SUPPLY
   CHECK  (MPRN IS NULL OR SUPPLY_UNIT IS NULL)
/


--------------------------------------------------------------------------------
PROMPT Create table TDIE_TUOS_INV_CHARGE_DTL...
CREATE TABLE TDIE_TUOS_INV_CHARGE_DTL(
   INVOICE_NUMBER              VARCHAR2(12)     NOT NULL,
   ACCOUNT_XID                 NUMBER           NOT NULL,
   METER_NAME                  VARCHAR2(128)     NOT NULL,
   INVOICE_CATEGORY            VARCHAR2(64),
   INV_DET_START_DATE          DATE             NOT NULL,
   INV_DET_END_DATE            DATE             NOT NULL,
   INV_DET_CATEGORY            VARCHAR2(64)     NOT NULL,
   INV_DET_TYPE                VARCHAR2(64)     NOT NULL,
   INV_DET_CODE                VARCHAR2(64)     NOT NULL,
   INV_DET_CATEGORY2           VARCHAR2(64)     NOT NULL,
   INV_DET_SEQ                 NUMBER           NOT NULL,
   INV_DET_NAME                VARCHAR2(100),
   INV_DET_VALUE               NUMBER,
   INV_DET_UOM                 VARCHAR2(10),
   MULTI_CIP_FLAG              VARCHAR2(1)      DEFAULT 'N' NOT NULL,
   VAT_CHARGE                  NUMBER,
   INV_DET_VALUE_CHARGE        NUMBER,
   INV_DET_VALUE_CHARGE_NO_VAT NUMBER,
   INV_DET_TYPE_SORT           VARCHAR2(3),
   EIR_RPT_INV_DET_ID          NUMBER,
   BILL_DATE                   DATE,
   CIP_DATE                    VARCHAR2(100),
   INV_STATUS_DRAFT            VARCHAR2(100),
   INV_NUMBER_RELEASED         VARCHAR2(12),
   INV_DATE_RELEASED           DATE,
   INV_DET_NOTES               VARCHAR2(1000),
   INV_DET_NOTE_SORT           VARCHAR2(3),
   DLAFG                       VARCHAR2(8),
   DG                          VARCHAR2(8),
   CONSTRAINT PK_TDIE_TUOS_INV_CHARGE_DTL
      PRIMARY KEY (INVOICE_NUMBER,
                   ACCOUNT_XID,
                   METER_NAME,
                   INV_DET_START_DATE,
                   INV_DET_END_DATE,
                   INV_DET_CATEGORY,
                   INV_DET_TYPE,
                   INV_DET_CODE,
                   INV_DET_CATEGORY2,
                   INV_DET_SEQ,
                   INV_DET_NOTE_SORT)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

PROMPT Creating foreign key FK_TDIE_TUOS_INV_CHARGE_DTL...
ALTER TABLE TDIE_TUOS_INV_CHARGE_DTL
   ADD CONSTRAINT FK_TUOS_INV_CHG_DTL_INV_DTL 
   FOREIGN KEY (INVOICE_NUMBER,
                ACCOUNT_XID,
                METER_NAME) 
   REFERENCES TDIE_TUOS_INVOICE_DETAIL (INVOICE_NUMBER,
                                        ACCOUNT_XID,
                                        METER_NAME)
   ON DELETE CASCADE
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_INVOICE_LINE_VALIDATION...
create table TDIE_INVOICE_LINE_VALIDATION (
	INVOICE_LINE_VALIDATION_ID	NUMBER(12)	NOT NULL,
	RETAIL_INVOICE_ID			NUMBER(9)	NOT NULL,
	MPRN						VARCHAR(32)	NOT NULL,
	SERIAL_NUMBER				VARCHAR(12)	NOT NULL,
	SUPPLY_UNIT					VARCHAR(32) NOT NULL,
	IS_VALID					NUMBER(1),
	ACCOUNT_ID					NUMBER(9),
	METER_ID					NUMBER(9),
	SERVICE_POINT_ID			NUMBER(9),
	IS_ACTIVE					NUMBER(1),
	HAS_SERVICE_LOCATION		NUMBER(1),
	JURISDICTION				VARCHAR(3),
	INTERNAL_EDC_ID				NUMBER(9),
	EXTERNAL_EDC_ID				NUMBER(9),
	INTERNAL_PSE_ID				NUMBER(9),
	EXTERNAL_PSE_ID				NUMBER(9),
	INTERNAL_TARIFF_CODE		VARCHAR(32),
	EXTERNAL_TARIFF_CODE		VARCHAR(32),
	INTERNAL_MIC				NUMBER,
	EXTERNAL_MIC				NUMBER,
	constraint PK_TDIE_INVOICE_LINE_VALID primary key (INVOICE_LINE_VALIDATION_ID)
       using index
       tablespace NERO_INDEX
       storage
       (
           initial 64K
           next 64K
           pctincrease 0
       )
)
storage
(
    initial 128K
    next 128K
    pctincrease 0
)
tablespace NERO_DATA
/

alter table TDIE_INVOICE_LINE_VALIDATION
   	add constraint AK_TDIE_INVOICE_LINE_VALID unique (RETAIL_INVOICE_ID, MPRN, SERIAL_NUMBER, SUPPLY_UNIT)
	using index 
	tablespace NERO_INDEX
	storage
	(
		initial 64K
		next 64K
		pctincrease 0
	)
/

alter table TDIE_INVOICE_LINE_VALIDATION
	add constraint CK01_TDIE_INVOICE_LINE_VALID check ((SUPPLY_UNIT = 'Not Assigned' AND MPRN <> 'Not Assigned') 
		OR (SUPPLY_UNIT <> 'Not Assigned' AND MPRN = 'Not Assigned'))
/

alter table TDIE_INVOICE_LINE_VALIDATION
	add constraint CK02_TDIE_INVOICE_LINE_VALID check (SERIAL_NUMBER = 'Not Assigned' 
		OR (SERIAL_NUMBER <> 'Not Assigned' AND MPRN <> 'Not Assigned' AND SUPPLY_UNIT = 'Not Assigned'))
/

alter table TDIE_INVOICE_LINE_VALIDATION
   add constraint FK_TDIE_INV_LN_VAL_RET_INV foreign key (RETAIL_INVOICE_ID)
      references RETAIL_INVOICE (RETAIL_INVOICE_ID)
	  on delete cascade
/

alter table TDIE_INVOICE_LINE_VALIDATION
   add constraint FK_TDIE_INV_LN_VAL_ACCOUNT foreign key (ACCOUNT_ID)
      references ACCOUNT (ACCOUNT_ID)
/

alter table TDIE_INVOICE_LINE_VALIDATION
   add constraint FK_TDIE_INV_LN_VAL_METER foreign key (METER_ID)
      references METER (METER_ID)
/

alter table TDIE_INVOICE_LINE_VALIDATION
   add constraint FK_TDIE_INV_LN_VAL_SVC_PT foreign key (SERVICE_POINT_ID)
      references SERVICE_POINT (SERVICE_POINT_ID)
/

alter table TDIE_INVOICE_LINE_VALIDATION
   add constraint FK1_TDIE_INV_LN_VAL_EDC foreign key (INTERNAL_EDC_ID)
      references ENERGY_DISTRIBUTION_COMPANY (EDC_ID)
/

alter table TDIE_INVOICE_LINE_VALIDATION
   add constraint FK2_TDIE_INV_LN_VAL_EDC foreign key (EXTERNAL_EDC_ID)
      references ENERGY_DISTRIBUTION_COMPANY (EDC_ID)
/

alter table TDIE_INVOICE_LINE_VALIDATION
   add constraint FK1_TDIE_INV_LN_VAL_PSE foreign key (INTERNAL_PSE_ID)
      references PURCHASING_SELLING_ENTITY (PSE_ID)
/

alter table TDIE_INVOICE_LINE_VALIDATION
   add constraint FK2_TDIE_INV_LN_VAL_PSE foreign key (EXTERNAL_PSE_ID)
      references PURCHASING_SELLING_ENTITY (PSE_ID)
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_INVOICE_COMP_VALIDATION
create table TDIE_INVOICE_COMP_VALIDATION (
	INVOICE_COMP_VALIDATION_ID	NUMBER(12)	NOT NULL,
	RETAIL_INVOICE_ID			NUMBER(9)	NOT NULL,
	MPRN						VARCHAR(32) NOT NULL,
	SERIAL_NUMBER				VARCHAR(12) NOT NULL,
	SUPPLY_UNIT					VARCHAR(32) NOT NULL,	
	TARIFF_CODE					VARCHAR(64)	NOT NULL,
	CHARGE_TYPE					VARCHAR(64)	NOT NULL,
	TIMESLOT_CODE 				VARCHAR(10),	
	CHARGE_STATE				NUMBER(9),	
	BEGIN_DATE					DATE,	
	END_DATE					DATE,	
	IS_VALID					NUMBER(1)   NOT NULL,
	PRODUCT_ID					NUMBER(9),	
	COMPONENT_ID				NUMBER(9),	
	PERIOD_ID					NUMBER(9),	
	INTERNAL_QUANTITY			NUMBER,	
	INTERNAL_RATE				NUMBER,	
	INTERNAL_AMOUNT				NUMBER,	
	EXTERNAL_QUANTITY			NUMBER,	
	EXTERNAL_RATE				NUMBER,	
	EXTERNAL_AMOUNT				NUMBER,
	constraint PK_TDIE_INVOICE_COMP_VALID primary key (INVOICE_COMP_VALIDATION_ID)
       using index
       tablespace NERO_INDEX
       storage
       (
           initial 64K
           next 64K
           pctincrease 0
       )
)
storage
(
    initial 128K
    next 128K
    pctincrease 0
)
tablespace NERO_DATA
/

alter table TDIE_INVOICE_COMP_VALIDATION
	add constraint CK01_TDIE_INV_COMP_VAL check (CHARGE_STATE IN (0,1,2,4,8,9))
/

alter table TDIE_INVOICE_COMP_VALIDATION
   add constraint FK_TDIE_INV_COMP_VL_INV_LN_VL foreign key (RETAIL_INVOICE_ID, MPRN, SERIAL_NUMBER, 
		SUPPLY_UNIT)
      references TDIE_INVOICE_LINE_VALIDATION (RETAIL_INVOICE_ID, MPRN, SERIAL_NUMBER, 
		SUPPLY_UNIT)
	  on delete cascade
/

alter table TDIE_INVOICE_COMP_VALIDATION
   add constraint FK_TDIE_INV_COMP_VAL_PRODUCT foreign key (PRODUCT_ID)
      references PRODUCT (PRODUCT_ID)
/

alter table TDIE_INVOICE_COMP_VALIDATION
   add constraint FK_TDIE_INV_COMP_VAL_COMPONENT foreign key (COMPONENT_ID)
      references COMPONENT (COMPONENT_ID)
/

alter table TDIE_INVOICE_COMP_VALIDATION
   add constraint FK_TDIE_INV_COMP_VAL_PERIOD foreign key (PERIOD_ID)
      references PERIOD (PERIOD_ID)
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_TUOS_INVOICE_DET_CODE_MAP
CREATE TABLE TDIE_TUOS_INVOICE_DET_CODE_MAP(
	CHARGE_NAME		VARCHAR2(64)	NOT NULL,
	RATE_NAME		VARCHAR2(64),	
	QUANTITY_NAME	VARCHAR2(64),	
	CONSTRAINT PK_TDIE_TUOS_INV_DET_CODE_MAP
		PRIMARY KEY (CHARGE_NAME)
		USING INDEX TABLESPACE NERO_INDEX
			STORAGE (INITIAL     128K
		   			 NEXT        128K
		   			 PCTINCREASE   0))
		STORAGE (INITIAL     128K
				 NEXT        128K
				 PCTINCREASE   0)
		TABLESPACE NERO_DATA
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_TUOS_SUPPLY_UNIT_MAP...
CREATE TABLE TDIE_TUOS_SUPPLY_UNIT_MAP(
    ACCOUNT_CODE  VARCHAR2(64)  NOT NULL, 
    METER_NAME    VARCHAR2(128)  NOT NULL, 
    SUPPLY_UNIT   VARCHAR2(64)  NOT NULL,
    CONSTRAINT PK_TDIE_TUOS_SUPPLY_UNIT_MAP
        PRIMARY KEY (ACCOUNT_CODE, METER_NAME)
        USING INDEX TABLESPACE NERO_INDEX
            STORAGE (INITIAL 128K
                     NEXT 128K
                     PCTINCREASE 0))
        STORAGE (INITIAL 128K
                 NEXT 128K
                 PCTINCREASE 0)
        TABLESPACE NERO_DATA
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_TUOS_CODES...
CREATE TABLE TDIE_TUOS_CODES(
   CODE_TYPE   VARCHAR2(64)   NOT NULL,
   CODE_VALUE  VARCHAR2(64)   NOT NULL,
   CONSTRAINT PK_TDIE_TUOS_CODES 
      PRIMARY KEY (CODE_TYPE, CODE_VALUE)
      USING INDEX TABLESPACE NERO_INDEX
      STORAGE (INITIAL     128K
               NEXT        128K
               PCTINCREASE   0))
   STORAGE (INITIAL     128K
            NEXT        128K
            PCTINCREASE   0)
   TABLESPACE NERO_DATA
/

--------------------------------------------------------------------------------
PROMPT Create table TDIE_ACCOUNT...
create table TDIE_ACCOUNT (
	ACCOUNT_ID			      NUMBER(9)	NOT NULL,
	LAST_READING_RCV_DATE	DATE NOT NULL,
	constraint PK_TDIE_ACCOUNT primary key (ACCOUNT_ID)
       using index
       tablespace NERO_INDEX
       storage
       (
           initial 64K
           next 64K
           pctincrease 0
       )
)
storage
(
    initial 128K
    next 128K
    pctincrease 0
)
tablespace NERO_DATA
/

alter table TDIE_ACCOUNT add constraint FK_TDIE_ACCOUNT
	foreign key (ACCOUNT_ID) references ACCOUNT(ACCOUNT_ID)
	on delete cascade;


PROMPT Creating index on TDIE_ACCOUNT...
CREATE INDEX TDIE_ACCOUNT_IX01
   ON TDIE_ACCOUNT (LAST_READING_RCV_DATE, ACCOUNT_ID)
STORAGE(INITIAL     128K
	     NEXT        128K
		  PCTINCREASE   0)
TABLESPACE NERO_INDEX 
/

--------------------------------------------------------------------------------
PROMPT Creating temporary table TDIE_EARN_ID_MPRN_SU_MAPPING...
CREATE GLOBAL TEMPORARY TABLE TDIE_EARN_ID_MPRN_SU_MAPPING(
   EARN_ID                 NUMBER(22) NOT NULL,
   EARN_NAME               VARCHAR2(128) NOT NULL,
   MPRN_ID                 NUMBER(22),
   MPRN_NAME               VARCHAR2(128),
   MPRN_BEGIN_DATE         DATE,
   MPRN_END_DATE           DATE,
   SU_ID                   NUMBER(22),
   SU_NAME                 VARCHAR2(128),
   SU_BEGIN_DATE           DATE,
   SU_END_DATE             DATE,
   COMMENTS                VARCHAR2(4000),
   SCHEDULE_GROUP_NAME     VARCHAR2(1000),
   SCHEDULE_GROUP_ID       NUMBER(22),
   ESP_EXTERNAL_IDENTIFIER VARCHAR2(128)
   ) ON COMMIT PRESERVE ROWS
/

PROMPT Adding constraint EARN_MPRN_SU_MAP_AK...
ALTER TABLE TDIE_EARN_ID_MPRN_SU_MAPPING
   ADD CONSTRAINT EARN_MPRN_SU_MAP_AK 
   UNIQUE (EARN_ID, MPRN_ID, MPRN_BEGIN_DATE, SU_ID, SU_BEGIN_DATE)
/
